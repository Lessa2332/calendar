<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Магічний пазл</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@2.2.1/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <style>
    body,html{margin:0;height:100%;overflow:hidden;background:#000}
    #hint{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:hotpink;color:#fff;padding:15px 30px;border-radius:50px;font-size:22px;z-index:999;font-family:sans-serif}
    #win{position:fixed;inset:0;background:rgba(0,0,0,0.95);color:gold;font-size:70px;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:1000}
    #win span{animation:bounce 1s infinite}
    @keyframes bounce{0%,100%{transform:scale(1)}50%{transform:scale(1.4)}}
  </style>
</head>
<body>

<div id="hint">Покажи маркер — і почнеться магія!</div>
<div id="win"><span>УРА!</span><br>Ти зібрав пазл!</div>

<a-scene
  embedded
  mindar-image="imageTargetSrc: calendar.mind; uiLoading: no; uiError: no; uiScanning: no"
  renderer="colorManagement: true; physicallyCorrectLights: true"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

  <a-camera></a-camera>

  <a-entity mindar-image-target="targetIndex: 0">
    <a-entity id="puzzle"></a-entity>
  </a-entity>
</a-scene>

<audio id="yay" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>

<script>
// Правильний запуск MindAR (це було головне!)
document.querySelector('a-scene').addEventListener('loaded', () => {
  const sceneEl = document.querySelector('a-scene');
  sceneEl.components['mindar-image-system'].start(); // ← ВИПРАВЛЕНО: просто start()
});

// Створюємо пазл коли маркер знайдено
document.querySelector('a-scene').addEventListener('targetFound', () => {
  if (document.getElementById('puzzle').children.length === 0) {
    setTimeout(createPuzzle, 600);
  }
});

async function createPuzzle() {
  const img = new Image();
  img.src = 'images/01.jpg?t=' + Date.now();
  await img.decode();

  const pw = img.width / 3;
  const ph = img.height / 3;
  const sw = 0.5 / 3;
  const sh = (img.height / img.width) * 0.5 / 3;
  const pieces = [];

  for (let y = 0; y < 3; y++) {
    for (let x = 0; x < 3; x++) {
      const canvas = document.createElement('canvas');
      canvas.width = pw; canvas.height = ph;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, x * pw, y * ph, pw, ph, 0, 0, pw, ph);

      const plane = document.createElement('a-plane');
      plane.setAttribute('src', canvas.toDataURL());
      plane.setAttribute('width', sw * 2);
      plane.setAttribute('height', sh * 2);
      plane.setAttribute('position', `${(Math.random() - 0.5) * 1.4} ${(Math.random() - 0.5) * 1.4} 0.02`);
      plane.setAttribute('data-target-x', (x - 1) * sw);
      plane.setAttribute('data-target-y', (1 - y) * sh);
      plane.classList.add('piece', 'raycastable');
      document.getElementById('puzzle').appendChild(plane);
      pieces.push(plane);
    }
  }

  // Клік по шматочку
  document.querySelector('a-scene').addEventListener('click', function handler(e) {
    const piece = e.detail.intersectedEls?.[0];
    if (!piece || !piece.classList.contains('piece')) return;

    const other = pieces.filter(p => p !== piece)[Math.floor(Math.random() * 8)];
    const temp = piece.getAttribute('position');
    piece.setAttribute('position', other.getAttribute('position'));
    other.setAttribute('position', temp);

    // Перевірка перемоги
    if (pieces.every(p => {
      const pos = p.getAttribute('position');
      const tx = parseFloat(p.dataset.targetX);
      const ty = parseFloat(p.dataset.targetY);
      return Math.abs(pos.x - tx) < 0.07 && Math.abs(pos.y - ty) < 0.07;
    })) {
      document.getElementById('win').style.display = 'flex';
      document.getElementById('yay').play();
      confetti({ particleCount: 500, spread: 120, origin: { y: 0.6 } });
      this.removeEventListener('click', handler); // більше не реагувати
    }
  });
}
</script>
</body>
</html>
