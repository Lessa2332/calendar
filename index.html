<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' 'unsafe-inline' data: blob: https://aframe.io https://cdn.jsdelivr.net https://assets.mixkit.co;
    script-src 'self' 'unsafe-inline' https://aframe.io https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline';
  ">
  <title>–ú–∞–≥—ñ—á–Ω–∏–π –ø–∞–∑–ª –¥–ª—è –∑—ñ—Ä–æ—á–∫–∏</title>
  
  <!-- A-Frame 1.7.0 + MindAR 2.2.1 -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@2.2.1/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    body, html {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      touch-action: none; /* –ó–∞–ø–æ–±—ñ–≥–∞—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É –∂–µ—Å—Ç—ñ–≤ */
    }
    #hint {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff1493;
      color: #fff;
      padding: 16px 32px;
      border-radius: 50px;
      font-size: 24px;
      z-index: 999;
      box-shadow: 0 0 30px #ff1493;
      text-align: center;
    }
    #win {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.97);
      color: gold;
      font-size: 80px;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 1000;
      text-align: center;
    }
    #win span {
      animation: bounce 1s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.5); }
    }
  </style>
</head>
<body>

<div id="hint">–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä ‚Äî —ñ –ø–æ—á–Ω–µ—Ç—å—Å—è –º–∞–≥—ñ—è!</div>
<div id="win"><span>–£–†–ê–ê–ê!</span><br>–¢–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π —á–∞—Ä—ñ–≤–Ω–∏–∫!</div>

<a-scene
  mindar-image="imageTargetSrc: ./calendar.mind; uiLoading: no; uiError: no; uiScanning: no; autoStart: false"
  renderer="colorManagement: true"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false"
  cursor="rayOrigin: mouse">

  <a-camera cursor="rayOrigin: mouse"></a-camera>
  <a-entity id="targets-container"></a-entity>

</a-scene>

<audio id="yay" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>

<script>
// –°—Ç–≤–æ—Ä—é—î–º–æ 12 —Ü—ñ–ª–µ–π –¥–ª—è marker 0‚Äì11
function createTargets() {
  const container = document.getElementById('targets-container');
  for (let i = 0; i < 12; i++) {
    const target = document.createElement('a-entity');
    target.setAttribute('mindar-image-target', `targetIndex: ${i}`);
    target.id = `target-${i}`;
    container.appendChild(target);
  }
}

// –ó–∞–ø—É—Å–∫–∞—î–º–æ AR –ª–∏—à–µ –ø—ñ—Å–ª—è –∫–ª—ñ–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
function startAR() {
  const scene = document.querySelector('a-scene');
  const mindarSystem = scene.systems?.['mindar-image-system'];
  if (mindarSystem && typeof mindarSystem.start === 'function') {
    mindarSystem.start().catch(err => {
      console.error('AR start failed:', err);
      document.getElementById('hint').textContent = '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞!';
    });
  }
  // –í–∏–¥–∞–ª—è—î–º–æ —Å–ª—É—Ö–∞—á–∞ (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ {once} –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–≤)
  document.body.removeEventListener('click', startAR);
}

// –û–±—Ä–æ–±–∫–∞ –∑–Ω–∞–π–¥–µ–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
let activeTargetIndex = null;
let clickHandler = null;

function onTargetFound(event) {
  const targetIndex = event.detail.targetIndex;
  if (activeTargetIndex === targetIndex) return;

  resetPuzzle();
  activeTargetIndex = targetIndex;
  setTimeout(() => createPuzzle(targetIndex), 500);
}

function onTargetLost(event) {
  const targetIndex = event.detail.targetIndex;
  if (activeTargetIndex === targetIndex) {
    resetPuzzle();
  }
}

function resetPuzzle() {
  if (clickHandler) {
    document.querySelector('a-scene').removeEventListener('click', clickHandler);
    clickHandler = null;
  }
  for (let i = 0; i < 12; i++) {
    const target = document.getElementById(`target-${i}`);
    if (target) target.innerHTML = '';
  }
  activeTargetIndex = null;
  document.getElementById('win').style.display = 'none';
}

async function createPuzzle(targetIndex) {
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = `./images/${String(targetIndex + 1).padStart(2, '0')}.jpg?t=${Date.now()}`;
  
  try {
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = () => reject(new Error('Image load failed'));
    });
  } catch (err) {
    alert(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è ${targetIndex + 1}`);
    resetPuzzle();
    return;
  }

  const pieceW = img.width / 3;
  const pieceH = img.height / 3;
  const scaleW = 0.5 / 3;
  const scaleH = (img.height / img.width) * 0.5 / 3;
  const pieces = [];
  const targetContainer = document.getElementById(`target-${targetIndex}`);

  for (let row = 0; row < 3; row++) {
    for (let col = 0; col < 3; col++) {
      const canvas = document.createElement('canvas');
      canvas.width = pieceW;
      canvas.height = pieceH;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, col * pieceW, row * pieceH, pieceW, pieceH, 0, 0, pieceW, pieceH);

      const plane = document.createElement('a-plane');
      plane.setAttribute('src', canvas.toDataURL('image/jpeg', 0.92));
      plane.setAttribute('width', scaleW * 2);
      plane.setAttribute('height', scaleH * 2);
      plane.setAttribute('position', `${(Math.random() - 0.5) * 1.4} ${(Math.random() - 0.5) * 1.4} 0.02`);
      plane.setAttribute('data-target-x', (col - 1) * scaleW);
      plane.setAttribute('data-target-y', (1 - row) * scaleH);
      plane.classList.add('piece');
      targetContainer.appendChild(plane);
      pieces.push(plane);
    }
  }

  // –ü–µ—Ä–µ–º—ñ—à—É–≤–∞–Ω–Ω—è
  for (let i = 0; i < 10; i++) {
    const a = Math.floor(Math.random() * 9);
    const b = Math.floor(Math.random() * 9);
    const posA = pieces[a].getAttribute('position');
    const posB = pieces[b].getAttribute('position');
    pieces[a].setAttribute('position', posB);
    pieces[b].setAttribute('position', posA);
  }

  // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É
  clickHandler = (e) => {
    const piece = e.detail.intersectedEl;
    if (!piece || !piece.classList.contains('piece')) return;

    const others = pieces.filter(p => p !== piece);
    if (others.length === 0) return;
    const other = others[Math.floor(Math.random() * others.length)];

    const tmp = piece.getAttribute('position');
    piece.setAttribute('position', other.getAttribute('position'));
    other.setAttribute('position', tmp);

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–º–æ–≥–∏
    const isSolved = pieces.every(p => {
      const pos = p.getAttribute('position');
      const tx = parseFloat(p.getAttribute('data-target-x'));
      const ty = parseFloat(p.getAttribute('data-target-y'));
      return Math.abs(pos.x - tx) < 0.07 && Math.abs(pos.y - ty) < 0.07;
    });

    if (isSolved) {
      document.getElementById('win').style.display = 'flex';
      document.getElementById('yay').play().catch(e => console.log("Audio play failed:", e));
      confetti({ particleCount: 600, spread: 120, origin: { y: 0.6 } });
      document.querySelector('a-scene').removeEventListener('click', clickHandler);
      clickHandler = null;
    }
  };

  document.querySelector('a-scene').addEventListener('click', clickHandler);
}

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
document.addEventListener('DOMContentLoaded', () => {
  createTargets();

  const scene = document.querySelector('a-scene');
  // üî• –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø—Ä–∞–≤–∏–ª—å–Ω—ñ —ñ–º–µ–Ω–∞ –ø–æ–¥—ñ–π –¥–ª—è MindAR 2.2.1
  scene.addEventListener('mindar-image-targetFound', onTargetFound);
  scene.addEventListener('mindar-image-targetLost', onTargetLost);

  // –ó–∞–ø—É—Å–∫ AR –∑–∞ –ø–µ—Ä—à–∏–º –∫–ª—ñ–∫–æ–º
  document.body.addEventListener('click', startAR, { once: true });
});
</script>
</body>
</html>
