<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Магічний пазл для зірочки</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <style>
    body, html {margin:0; padding:0; height:100%; overflow:hidden; background:#000;}
    .mindar-video-container video, video {object-fit: cover !important;}
    
    #hint, #counter {
      position:fixed; z-index:999; color:#fff; padding:14px 28px; border-radius:50px; font-family:'Comic Sans MS',cursive;
      box-shadow:0 0 30px #ff1493; font-size:24px;
    }
    #hint {top:20px; left:50%; transform:translateX(-50%); background:#ff1493;}
    #counter {top:80px; left:20px; background:rgba(255,20,147,0.85);}

    #win {position:fixed; inset:0; background:rgba(0,0,0,0.97); color:gold; font-size:80px;
          display:none; align-items:center; justify-content:center; flex-direction:column; z-index:1000;}
    #win span {animation:bounce 1s infinite;}
    @keyframes bounce {0%,100%{transform:scale(1)} 50%{transform:scale(1.5)}}

    #loading {position:fixed; inset:0; background:#000; color:#ff1493; font-size:28px;
              display:flex; align-items:center; justify-content:center; z-index:1001;}
    
    canvas {position:absolute; touch-action:none; border:4px solid #ff1493; border-radius:16px; box-shadow:0 0 40px #ff1493;}
  </style>
</head>
<body>
  <div id="hint">Покажи маркер камері → збирай пазл пальцем!</div>
  <div id="counter">Зібрано: 0 з 12</div>
  <div id="win"><span>УРААА! ♥</span><br>Ти найкраща чарівниця!</div>
  <div id="loading">Завантажуємо магію…</div>

  <a-scene embedded mindar-image="imageTargetSrc: calendar.mind; filterMinCF:0.0001; filterBeta:0.01;"
    renderer="antialias:true" vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:false">
    
    <a-entity mindar-image-system="showBackground: true;"></a-entity>
    <a-camera></a-camera>

    <!-- 12 маркерів – тільки для детекту -->
    <a-entity id="anchor0"  mindar-image-target="targetIndex: 0"></a-entity>
    <a-entity id="anchor1"  mindar-image-target="targetIndex: 1"></a-entity>
    <a-entity id="anchor2"  mindar-image-target="targetIndex: 2"></a-entity>
    <a-entity id="anchor3"  mindar-image-target="targetIndex: 3"></a-entity>
    <a-entity id="anchor4"  mindar-image-target="targetIndex: 4"></a-entity>
    <a-entity id="anchor5"  mindar-image-target="targetIndex: 5"></a-entity>
    <a-entity id="anchor6"  mindar-image-target="targetIndex: 6"></a-entity>
    <a-entity id="anchor7"  mindar-image-target="targetIndex: 7"></a-entity>
    <a-entity id="anchor8"  mindar-image-target="targetIndex: 8"></a-entity>
    <a-entity id="anchor9"  mindar-image-target="targetIndex: 9"></a-entity>
    <a-entity id="anchor10" mindar-image-target="targetIndex: 10"></a-entity>
    <a-entity id="anchor11" mindar-image-target="targetIndex: 11"></a-entity>
  </a-scene>

  <audio id="yay" preload="auto"></audio>

  <script>
    const TOTAL = 12;
    let solved = 0;
    let currentPuzzle = null;

    // === Canvas-пазл ===
    class Puzzle {
      constructor(idx) {
        this.idx = idx;
        this.canvas = document.createElement('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.canvas.width = 900;
        this.canvas.height = 900;
        this.pieces = [];
        this.solved = false;
        document.body.appendChild(this.canvas);
        this.loadImage();
      }

      async loadImage() {
        const url = `images/${String(this.idx+1).padStart(2,'0')}.jpg?t=${Date.now()}`;
        const img = await new Promise((res, rej) => {
          const i = new Image();
          i.crossOrigin = "anonymous";
          i.onload = () => res(i);
          i.onerror = () => res(null);
          i.src = url;
        });

        if (!img) { this.fallback(); return; }
        this.createPieces(img);
      }

      createPieces(img) {
        const size = 300; // 3×3
        const positions = [];
        for(let i=0;i<3;i++) for(let j=0;j<3;j++) positions.push({x:j,y:i});

        this.pieces = positions.map((p, k) => {
          const canvas = document.createElement('canvas');
          canvas.width = canvas.height = size;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, p.x*size, p.y*size, size, size, 0, 0, size, size);

          const targetX = p.x * size - 450 + Math.random()*300-150;
          const targetY = p.y * size - 450 + Math.random()*300-150;

          return {
            img: canvas,
            homeX: p.x * size - 450 + 450, // центр
            homeY: p.y * size - 450 + 450,
            x: targetX,
            y: targetY,
            w: size,
            h: size
          };
        });

        this.shuffle();
        this.draw();
        this.attachEvents();
      }

      shuffle() {
        this.pieces.forEach(p => {
          p.x = Math.random()*600 - 300;
          p.y = Math.random()*600 - 300;
        });
      }

      draw() {
        this.ctx.clearRect(0,0,900,900);
        this.pieces.forEach(p => {
          this.ctx.drawImage(p.img, p.x, p.y, p.w, p.h);
        });
      }

      attachEvents() {
        let dragged = null;
        const canvas = this.canvas;

        const start = (e) => {
          if (this.solved) return;
          const touch = e.touches ? e.touches[0] : e;
          const rect = canvas.getBoundingClientRect();
          const x = touch.clientX - rect.left;
          const y = touch.clientY - rect.top;

          for (let i = this.pieces.length-1; i >= 0; i--) {
            const p = this.pieces[i];
            if (x > p.x && x < p.x+p.w && y > p.y && y < p.y+p.h) {
              dragged = p;
              // підняти наверх
              this.pieces.splice(i,1);
              this.pieces.push(p);
              break;
            }
          }
        };

        const move = (e) => {
          if (!dragged) return;
          e.preventDefault();
          const touch = e.touches ? e.touches[0] : e;
          const rect = canvas.getBoundingClientRect();
          dragged.x = touch.clientX - rect.left - dragged.w/2;
          dragged.y = touch.clientY - rect.top - dragged.h/2;
          this.draw();
        };

        const end = () => {
          if (!dragged) return;
          const dx = dragged.x - dragged.homeX;
          const dy = dragged.y - dragged.homeY;
          if (Math.abs(dx)<80 && Math.abs(dy)<80) {
            dragged.x = dragged.homeX;
            dragged.y = dragged.homeY;
          }
          this.draw();

          // перевірка чи всі на місці
          const allOk = this.pieces.every(p => 
            Math.abs(p.x - p.homeX)<30 && Math.abs(p.y - p.homeY)<30
          );
          if (allOk && !this.solved) {
            this.solved = true;
            solved++;
            document.getElementById('counter').textContent = `Зібрано: ${solved} з 12`;
            document.getElementById('yay').src = `fon/${String(this.idx+1).padStart(2,'0')}.mp3`;
            document.getElementById('yay').play();
            confetti({particleCount:500, spread:120, origin:{x:0.5,y:0.7}});
            if (solved === 12) setTimeout(() => document.getElementById('win').style.display='flex', 1500);
          }
          dragged = null;
        };

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('touchstart', start);
        canvas.addEventListener('mousemove', move);
        canvas.addEventListener('touchmove', move, {passive:false});
        canvas.addEventListener('mouseup', end);
        canvas.addEventListener('touchend', end);
      }

      fallback() {
        this.ctx.fillStyle = '#ff1493';
        this.ctx.font = '80px Comic Sans MS';
        this.ctx.textAlign = 'center';
        this.ctx.fillText('Фото не знайдено :(', 450, 450);
      }

      show(x, y, w, h) {
        this.canvas.style.left = x + 'px';
        this.canvas.style.top = y + 'px';
        this.canvas.style.width = w + 'px';
        this.canvas.style.height = h + 'px';
        this.canvas.style.display = 'block';
      }

      hide() {
        this.canvas.style.display = 'none';
      }
    }

    // === MindAR події ===
    const sceneEl = document.querySelector('a-scene');
    const puzzles = {};

    sceneEl.addEventListener('loaded', () => {
      document.getElementById('loading').remove();

      // автозапуск камери при першому кліку
      document.body.addEventListener('click', () => {
        sceneEl.systems['mindar-image-system'].start();
        document.getElementById('hint').textContent = 'Збирай пазл пальцем!';
      }, {once:true});

      for(let i=0; i<TOTAL; i++) {
        const anchor = document.getElementById(`anchor${i}`);
        
        anchor.addEventListener('targetFound', () => {
          if (currentPuzzle) currentPuzzle.hide();
          if (!puzzles[i]) puzzles[i] = new Puzzle(i);
          
          currentPuzzle = puzzles[i];
          if (currentPuzzle.solved) return;

          // розміщуємо canvas точно над маркером (розмір маркера ≈ 1 метр)
          const size = Math.min(window.innerWidth*0.9, window.innerHeight*0.7);
          const left = (window.innerWidth - size)/2;
          const top = (window.innerHeight - size)/2;

          currentPuzzle.show(left, top, size, size);
        });

        anchor.addEventListener('targetLost', () => {
          if (currentPuzzle && currentPuzzle.idx === i) {
            currentPuzzle.hide();
            currentPuzzle = null;
          }
        });
      }
    });
  </script>
</body>
</html>
