<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>–ú–∞–≥—ñ—á–Ω–∏–π –ø–∞–∑–ª –¥–ª—è –∑—ñ—Ä–æ—á–∫–∏</title>

  <!-- ‚úÖ CSP-safe –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è 2025: A-Frame + MindAR 1.2.5 -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    body, html { margin:0; height:100%; overflow:hidden; background:#000; font-family:'Comic Sans MS',cursive,sans-serif; }
    #hint {
      position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:#ff1493; color:#fff; padding:16px 32px; border-radius:50px;
      font-size:24px; z-index:999; box-shadow:0 0 30px #ff1493; text-align:center;
    }
    #win {
      position:fixed; inset:0; background:rgba(0,0,0,0.97); color:gold; font-size:80px;
      display:none; align-items:center; justify-content:center; flex-direction:column;
      z-index:1000; text-align:center;
    }
    #win span { animation:bounce 1s infinite; }
    @keyframes bounce { 0%,100%{transform:scale(1)} 50%{transform:scale(1.5)} }
    
    #loading {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      color:#fff; font-size:20px; z-index:1001; text-align:center;
    }
    
    #cameraPreview {
      position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:0;
      display:none;
    }
  </style>
</head>
<body>

  <video id="cameraPreview" playsinline muted autoplay></video>
  <div id="hint">–ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –µ–∫—Ä–∞–Ω ‚Üí –ø–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä ‚Üí –∑–±–∏—Ä–∞–π –ø–∞–∑–ª!</div>
  <div id="win"><span>–£–†–ê–ê–ê!</span><br>–¢–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π —á–∞—Ä—ñ–≤–Ω–∏–∫!</div>
  <div id="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

  <a-scene
    embedded
    mindar-image="imageTargetSrc: ./calendar.mind; filterMinCF:0.0001; filterBeta:1000; warmupTolerance:5; uiLoading:no; uiError:no; uiScanning:no; autoStart:false"
    renderer="colorManagement:true; legacyLights: false"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false">
    
    <a-camera 
      active="false"
      raycaster="objects: .piece; far: 100"
      cursor="fuse: false; rayOrigin: mouse">
    </a-camera>
    <a-entity id="targets-container"></a-entity>
  </a-scene>

  <audio id="yay" preload="auto">
    <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
  </audio>

  <script>
    let activeTargetIndex = null;
    let clickHandler = null;
    let targetsCreated = false;
    let userInteracted = false;
    let cameraStream = null;

    function unlockAudio() {
        if (userInteracted) return;
        userInteracted = true;
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        ctx.resume();
        const sounds = document.querySelectorAll('audio');
        sounds.forEach(s => { s.play().catch(()=>{}); s.pause(); s.currentTime = 0; });
    }

    function createTargets() {
      if (targetsCreated) return;
      const container = document.getElementById('targets-container');
      for (let i = 0; i < 12; i++) {
        const target = document.createElement('a-entity');
        target.setAttribute('mindar-image-target', { targetIndex: i });
        target.id = `target-${i}`;
        container.appendChild(target);
      }
      targetsCreated = true;
      console.log('‚úÖ –¶—ñ–ª—ñ —Å—Ç–≤–æ—Ä–µ–Ω—ñ');
    }

    async function startAR() {
      console.log('üöÄ –ó–∞–ø—É—Å–∫ AR...');
      
      try {
        // –°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º—É—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–µ–≤'—é –∫–∞–º–µ—Ä–∏
        const cameraPreview = document.getElementById('cameraPreview');
        cameraPreview.srcObject = cameraStream;
        cameraPreview.style.display = 'block';
        
        console.log('‚úÖ –ö–∞–º–µ—Ä–∞ —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞');

        const scene = document.querySelector('a-scene');
        const mindarComponent = scene.components['mindar-image'];

        if (!mindarComponent) {
          console.error('‚ùå –ö–æ–º–ø–æ–Ω–µ–Ω—Ç mindar-image –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
          document.getElementById('hint').textContent = '–ü–æ–º–∏–ª–∫–∞: MindAR –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ';
          document.getElementById('loading').style.display = 'none';
          return;
        }

        if (mindarComponent.arSession) {
          console.log('‚úÖ AR –≤–∂–µ –∑–∞–ø—É—â–µ–Ω–æ');
          return;
        }

        // –ó–∞–ø—É—Å–∫–∞—î–º–æ MindAR –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–∞–º–µ—Ä–∏
        mindarComponent.start().then(() => {
          console.log('‚úÖ AR —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ');
          document.getElementById('hint').textContent = '–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä –∫–∞–º–µ—Ä—ñ! üì±';
          document.getElementById('loading').style.display = 'none';
          
          // –ê–∫—Ç–∏–≤—É—î–º–æ –∫–∞–º–µ—Ä—É A-Frame –ø—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É MindAR
          const aframeCamera = document.querySelector('a-camera');
          aframeCamera.setAttribute('active', 'true');
          
        }).catch(err => {
          console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É AR:', err);
          document.getElementById('hint').textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞ AR! –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂ —Å—Ç–æ—Ä—ñ–Ω–∫—É.';
          document.getElementById('loading').style.display = 'none';
        });

      } catch (err) {
        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏:', err);
        document.getElementById('hint').textContent = '‚ùå –î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏! –ù–∞—Ç–∏—Å–Ω–∏ –∑–Ω–æ–≤—É.';
        document.getElementById('loading').style.display = 'none';
        
        // –î–æ–∑–≤–æ–ª—è—î–º–æ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑
        userInteracted = false;
      }
    }

    function onTargetFound(e) {
      const idx = e.detail.targetIndex;
      console.log(`üéØ –ó–Ω–∞–π–¥–µ–Ω–æ —Ü—ñ–ª—å: ${idx}`);
      if (activeTargetIndex === idx) return;
      resetPuzzle();
      activeTargetIndex = idx;
      setTimeout(() => createPuzzle(idx), 300);
    }

    function onTargetLost(e) {
      console.log(`‚ùå –í—Ç—Ä–∞—á–µ–Ω–æ —Ü—ñ–ª—å: ${e.detail.targetIndex}`);
      if (activeTargetIndex === e.detail.targetIndex) {
        resetPuzzle();
      }
    }

    function resetPuzzle() {
      if (clickHandler) {
        document.querySelector('a-scene').removeEventListener('click', clickHandler);
        clickHandler = null;
      }
      for (let i = 0; i < 12; i++) {
        const el = document.getElementById(`target-${i}`);
        if (el) el.innerHTML = '';
      }
      activeTargetIndex = null;
      document.getElementById('win').style.display = 'none';
    }

    function createPuzzle(targetIndex) {
      const container = document.getElementById(`target-${targetIndex}`);
      if (!container) return;

      const pieces = [];
      const rows = 3, cols = 3;
      const scale = 0.15;
      const spacing = 0.02;

      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const piece = document.createElement('a-box');
          const hue = (row * cols + col) * 40;
          piece.setAttribute('color', `hsl(${hue}, 100%, 50%)`);
          piece.setAttribute('depth', 0.01);
          piece.setAttribute('width', scale);
          piece.setAttribute('height', scale);

          const targetX = (col - 1) * (scale + spacing);
          const targetY = (1 - row) * (scale + spacing);

          const startX = (Math.random() - 0.5) * 0.8;
          const startY = (Math.random() - 0.5) * 0.8;

          piece.setAttribute('position', { x: startX, y: startY, z: 0.05 });
          piece.setAttribute('data-target-x', targetX);
          piece.setAttribute('data-target-y', targetY);
          piece.setAttribute('data-target-z', 0.02);
          piece.classList.add('piece');

          const text = document.createElement('a-text');
          text.setAttribute('value', `${row * cols + col + 1}`);
          text.setAttribute('align', 'center');
          text.setAttribute('color', '#fff');
          text.setAttribute('position', '0 0 0.006');
          text.setAttribute('scale', '0.2 0.2 0.2');
          piece.appendChild(text);

          container.appendChild(piece);
          pieces.push(piece);
        }
      }

      clickHandler = (e) => {
        const piece = e.detail.intersectedEl;
        if (!piece || !piece.classList.contains('piece')) return;

        const otherPieces = pieces.filter(p => p !== piece);
        if (otherPieces.length === 0) return;

        const swapPiece = otherPieces[Math.floor(Math.random() * otherPieces.length)];
        const tempPos = piece.getAttribute('position');
        piece.setAttribute('position', swapPiece.getAttribute('position'));
        swapPiece.setAttribute('position', tempPos);

        checkPuzzleSolved(pieces);
      };

      document.querySelector('a-scene').addEventListener('click', clickHandler);
      console.log(`‚úÖ –ü–∞–∑–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ –¥–ª—è —Ü—ñ–ª—ñ ${targetIndex}`);
    }

    function checkPuzzleSolved(pieces) {
      const solved = pieces.every(piece => {
        const pos = piece.getAttribute('position');
        const targetX = parseFloat(piece.getAttribute('data-target-x'));
        const targetY = parseFloat(piece.getAttribute('data-target-y'));
        const targetZ = parseFloat(piece.getAttribute('data-target-z'));
        return Math.abs(pos.x - targetX) < 0.05 && 
               Math.abs(pos.y - targetY) < 0.05 && 
               Math.abs(pos.z - targetZ) < 0.05;
      });

      if (solved) {
        console.log('üéâ –ü–∞–∑–ª –∑—ñ–±—Ä–∞–Ω–æ!');
        document.getElementById('win').style.display = 'flex';

        const audio = document.getElementById('yay');
        audio.play().catch(e => console.log('üîá –ó–≤—É–∫ –Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–æ:', e));

        confetti({ 
          particleCount: 300, 
          spread: 100, 
          origin: { y: 0.6 },
          colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff']
        });

        if (clickHandler) {
          document.querySelector('a-scene').removeEventListener('click', clickHandler);
          clickHandler = null;
        }
      }
    }

    function cleanup() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      resetPuzzle();
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ü–µ–Ω–∏
    document.querySelector('a-scene').addEventListener('loaded', () => {
      console.log('üé¨ –°—Ü–µ–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');

      createTargets();

      const sceneEl = document.querySelector('a-scene');
      sceneEl.addEventListener('targetFound', onTargetFound);
      sceneEl.addEventListener('targetLost', onTargetLost);

      document.body.addEventListener('click', () => {
        unlockAudio();
        startAR();
      }, { once: true });

      document.getElementById('hint').textContent = '–ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –µ–∫—Ä–∞–Ω –¥–ª—è –∑–∞–ø—É—Å–∫—É –∫–∞–º–µ—Ä–∏!';
      document.getElementById('loading').style.display = 'none';
    });

    document.querySelector('a-scene').addEventListener('error', (e) => {
      console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ü–µ–Ω–∏:', e);
      document.getElementById('hint').textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AR!';
      document.getElementById('loading').style.display = 'none';
    });

    // –ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    window.addEventListener('beforeunload', cleanup);
    window.addEventListener('pagehide', cleanup);
  </script>
</body>
</html>
