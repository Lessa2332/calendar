<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Магічне розфарбовування</title>

  <!-- CSP-safe бібліотеки -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.7.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mindar@2.2.1/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body, html {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    #hint {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff1493;
      color: #fff;
      padding: 16px 32px;
      border-radius: 50px;
      font-size: 24px;
      z-index: 999;
      box-shadow: 0 0 30px #ff1493;
      text-align: center;
    }
    .controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 20px;
    }
    .color-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid #444;
      cursor: pointer;
    }
    .slider {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    input[type="range"] {
      width: 100px;
    }
    .zoom-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="hint">Покажи маркер — і почнеться магія!</div>

<a-scene
  embedded
  mindar-image="imageTargetSrc: ./calendar.mind; autoStart: false; uiLoading: no; uiError: no; uiScanning: no;
                debug: true"
  renderer="colorManagement: true;
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

  <a-camera></a-camera>
  <a-entity id="drawing-container"></a-entity>

</a-scene>

<div class="controls">
  <div class="colors">
    <div class="color-btn" style="background:#ff6961" onclick="setColor('#ff6961')"></div>
    <div class="color-btn" style="background:#fdfd96" onclick="setColor('#fdfd96')"></div>
    <div class="color-btn" style="background:#77dd77" onclick="setColor('#77dd77')"></div>
    <div class="color-btn" style="background:#84b6f4" onclick="setColor('#84b6f4')"></div>
    <div class="color-btn" style="background:#fdcae1" onclick="setColor('#fdcae1')"></div>
    <div class="color-btn" style="background:#cbaacb" onclick="setColor('#cbaacb')"></div>
    <div class="color-btn" style="background:#ff9ff3" onclick="setColor('#ff9ff3')"></div>
    <div class="color-btn" style="background:#feca57" onclick="setColor('#feca57')"></div>
    <div class="color-btn" style="background:#ffbe76" onclick="setColor('#ffbe76')"></div>
    <div class="color-btn" style="background:#55efc4" onclick="setColor('#55efc4')"></div>
    <div class="color-btn" style="background:#a29bfe" onclick="setColor('#a29bfe')"></div>
    <div class="color-btn" style="background:#2d3436" onclick="setColor('#2d3436')"></div>
  </div>
  <div class="slider">
    <span>Розмір:</span>
    <input type="range" id="brushSize" min="1" max="30" value="10" oninput="setBrushSize(this.value)">
  </div>
  <div class="zoom-controls">
    <div class="zoom-btn" onclick="zoomIn()">+</div>
    <div class="zoom-btn" onclick="zoomOut()">–</div>
  </div>
</div>

<script>
let isDrawing = false;
let lastX = 0, lastY = 0;
let currentColor = '#ff6961';
let brushSize = 10;
let drawingCanvas = null;
let ctx = null;
let baseImage = null;
let scale = 1.0;
let activeTargetIndex = null;
let audio = null;

// Створюємо 12 цілей для маркерів 0–11
function createTargets() {
  const container = document.getElementById('drawing-container');
  for (let i = 0; i < 12; i++) {
    const target = document.createElement('a-entity');
    target.setAttribute('mindar-image-target', `targetIndex: ${i}`);
    target.id = `target-${i}`;
    container.appendChild(target);
  }
}

// Запуск AR після кліку
function startAR() {
  const scene = document.querySelector('a-scene');
  const sys = scene.systems?.['mindar-image'];
  if (sys && !sys.initialized) {
    sys.start();
    document.getElementById('hint').style.display = 'none';
  }
}

// Коли маркер знайдено — завантажуємо зображення та звук
document.querySelector('a-scene').addEventListener('targetFound', async (event) => {
  const targetIndex = event.detail.targetIndex;
  if (activeTargetIndex === targetIndex) return;
  resetPuzzle();
  activeTargetIndex = targetIndex;
  await loadAsset(activeTargetIndex);
});

function resetPuzzle() {
  if (audio) {
    audio.pause();
    audio = null;
  }
  const container = document.getElementById('drawing-container');
  container.innerHTML = '';
  isDrawing = false;
  lastX = 0;
  lastY = 0;
  drawingCanvas = null;
  ctx = null;
  baseImage = null;
  scale = 1.0;
  activeTargetIndex = null;
}

async function loadAsset(targetIndex) {
  // Завантажуємо зображення
  const img = new Image();
  img.src = `./images/${String(targetIndex + 1).padStart(2, '0')}.jpg?t=${Date.now()}`;

  await new Promise((res, rej) => {
    img.onload = res;
    img.onerror = rej;
  });

  // Завантажуємо звук
  audio = new Audio(`./fon/fon${targetIndex + 1}.mp3`);
  audio.loop = true;
  audio.play().catch(() => {});

  baseImage = img;
  createDrawingCanvas(img, targetIndex);
}

function createDrawingCanvas(img, targetIndex) {
  const canvas = document.createElement('canvas');
  canvas.width = img.width;
  canvas.height = img.height;
  const context = canvas.getContext('2d');

  // Малюємо чорно-біле зображення
  context.drawImage(img, 0, 0);

  // Створюємо a-plane
  const plane = document.createElement('a-plane');
  plane.setAttribute('width', 0.6 * scale);
  plane.setAttribute('height', (img.height / img.width) * 0.6 * scale);
  plane.setAttribute('position', '0 0 0.02');
  plane.setAttribute('src', canvas.toDataURL());
  plane.classList.add('draw-surface');

  document.getElementById(`target-${targetIndex}`).appendChild(plane);

  drawingCanvas = canvas;
  ctx = context;

  // Події малювання
  plane.addEventListener('mousedown', startDraw);
  plane.addEventListener('mouseup', stopDraw);
  plane.addEventListener('mousemove', draw);
  plane.addEventListener('touchstart', startDraw, { passive: false });
  plane.addEventListener('touchend', stopDraw, { passive: false });
  plane.addEventListener('touchmove', draw, { passive: false });

  // Події масштабування
  let startX, startY, startScale;
  plane.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      startScale = scale;
    }
  }, { passive: false });

  plane.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      const distance = Math.sqrt(dx*dx + dy*dy);
      scale = startScale + distance * 0.001;
      scale = Math.max(0.5, Math.min(2.0, scale)); // обмеження масштабу
      updatePlaneSize();
    }
  }, { passive: false });
}

function updatePlaneSize() {
  const plane = document.querySelector('.draw-surface');
  plane.setAttribute('width', 0.6 * scale);
  plane.setAttribute('height', (baseImage.height / baseImage.width) * 0.6 * scale);
  plane.setAttribute('src', drawingCanvas.toDataURL());
}

function getRelativePos(e) {
  const rect = document.querySelector('.draw-surface').getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  const scaleX = drawingCanvas.width / rect.width;
  const scaleY = drawingCanvas.height / rect.height;
  return {
    x: (clientX - rect.left) * scaleX,
    y: (clientY - rect.top) * scaleY
  };
}

function startDraw(e) {
  e.preventDefault();
  isDrawing = true;
  const pos = getRelativePos(e);
  lastX = pos.x;
  lastY = pos.y;
}

function stopDraw(e) {
  e.preventDefault();
  isDrawing = false;
}

function draw(e) {
  if (!isDrawing || !ctx) return;
  e.preventDefault();
  const pos = getRelativePos(e);
  
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(pos.x, pos.y);
  ctx.strokeStyle = currentColor;
  ctx.lineWidth = brushSize;
  ctx.lineCap = 'round';
  ctx.stroke();

  // Оновлюємо текстуру
  const plane = document.querySelector('.draw-surface');
  plane.setAttribute('src', drawingCanvas.toDataURL());

  lastX = pos.x;
  lastY = pos.y;
}

// Функції для кольору та розміру
function setColor(color) {
  currentColor = color;
  document.querySelectorAll('.color-btn').forEach(btn => btn.style.border = '2px solid #444');
  event.target.style.border = '2px solid #fff';
}

function setBrushSize(size) {
  brushSize = parseInt(size);
}

function zoomIn() {
  scale = Math.min(2.0, scale + 0.1);
  updatePlaneSize();
}

function zoomOut() {
  scale = Math.max(0.5, scale - 0.1);
  updatePlaneSize();
}

// Ініціалізація
document.addEventListener('DOMContentLoaded', () => {
  createTargets();
  document.body.addEventListener('click', startAR, { once: true });
});
</script>
</body>
</html>
