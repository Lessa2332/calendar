<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>–ú–∞–≥—ñ—á–Ω–∏–π –ø–∞–∑–ª –¥–ª—è –∑—ñ—Ä–æ—á–∫–∏</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    body, html {margin:0; height:100%; overflow:hidden; background:#000; font-family:'Comic Sans MS',cursive,sans-serif;}
    
    /* –ö–ê–ú–ï–†–ê –í–ò–î–ù–û! */
    .mindar-ui-overlay, .mindar-ui-loading, .mindar-ui-scanning { display: none !important; }
    .mindar-video-container video { display: block !important; }
    
    a-scene, .a-canvas {background:transparent !important;}

    #hint, #counter {
      position:fixed; padding:16px 32px; border-radius:50px; font-size:24px; z-index:999; color:#fff; box-shadow:0 0 30px #ff1493;
    }
    #hint {top:20px; left:50%; transform:translateX(-50%); background:#ff1493; text-align:center;}
    #counter {top:80px; left:20px; background:rgba(255,20,147,0.8);}
    
    #win {position:fixed; inset:0; background:rgba(0,0,0,0.97); color:gold; font-size:80px;
          display:none; align-items:center; justify-content:center; flex-direction:column; z-index:1000;}
    #win span {animation:bounce 1s infinite;}
    @keyframes bounce {0%,100%{transform:scale(1)} 50%{transform:scale(1.5)}}
    #loading {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:20px; z-index:1001;}
    
    #startButton {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#ff1493; color:white; border:none; padding:20px 40px;
      border-radius:50px; font-size:24px; cursor:pointer; z-index:1002;
      box-shadow:0 0 30px #ff1493;
    }
  </style>
</head>
<body>
  <div id="hint" style="display:none;">–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä –∫–∞–º–µ—Ä—ñ ‚Üí –ø–µ—Ä–µ—Ç—è–≥—É–π —à–º–∞—Ç–æ—á–∫–∏!</div>
  <div id="counter" style="display:none;">–ó—ñ–±—Ä–∞–Ω–æ: 0 –∑ 12</div>
  <div id="win"><span>–£–†–ê–ê–ê!</span><br>–¢–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π —á–∞—Ä—ñ–≤–Ω–∏–∫!</div>
  <div id="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –º–∞–≥—ñ—é...</div>
  <button id="startButton">üéÆ –ü–û–ß–ê–¢–ò –ì–†–£ üéÆ</button>

  <a-scene
    embedded
    mindar-image="imageTargetSrc: calendar.mind; filterMinCF:0.0001; filterBeta:0.01; autoStart: false;"
    renderer="colorManagement: true; antialias: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-camera 
      raycaster="objects: .puzzle-piece; far: 100"
      cursor="fuse: false; rayOrigin: mouse">
    </a-camera>

    <!-- 12 –º–∞—Ä–∫–µ—Ä—ñ–≤ -->
    <a-entity id="target-0"  mindar-image-target="targetIndex: 0"></a-entity>
    <a-entity id="target-1"  mindar-image-target="targetIndex: 1"></a-entity>
    <a-entity id="target-2"  mindar-image-target="targetIndex: 2"></a-entity>
    <a-entity id="target-3"  mindar-image-target="targetIndex: 3"></a-entity>
    <a-entity id="target-4"  mindar-image-target="targetIndex: 4"></a-entity>
    <a-entity id="target-5"  mindar-image-target="targetIndex: 5"></a-entity>
    <a-entity id="target-6"  mindar-image-target="targetIndex: 6"></a-entity>
    <a-entity id="target-7"  mindar-image-target="targetIndex: 7"></a-entity>
    <a-entity id="target-8"  mindar-image-target="targetIndex: 8"></a-entity>
    <a-entity id="target-9"  mindar-image-target="targetIndex: 9"></a-entity>
    <a-entity id="target-10" mindar-image-target="targetIndex: 10"></a-entity>
    <a-entity id="target-11" mindar-image-target="targetIndex: 11"></a-entity>
  </a-scene>

  <audio id="yay" preload="auto"></audio>

  <script>
    // === –ü–û–ö–†–ê–©–ï–ù–ò–ô DRAG COMPONENT ===
    AFRAME.registerComponent('drag-puzzle-piece', {
      init: function () {
        this.el.classList.add('puzzle-piece');
        this.dragging = false;
        this.offset = new THREE.Vector3();
      },
      
      tick: function() {
        if (!this.dragging || !window.activeTarget) return;
        
        const camera = document.querySelector('[camera]').object3D;
        const raycaster = camera.getObject3D('raycaster');
        const mouse = { x: 0, y: 0 };
        
        // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –º–∏—à—ñ/—Ç–∞—á—É
        if (window.lastMousePos) {
          mouse.x = (window.lastMousePos.x / window.innerWidth) * 2 - 1;
          mouse.y = -(window.lastMousePos.y / window.innerHeight) * 2 + 1;
        }
        
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(
          document.querySelectorAll('.puzzle-piece').map(el => el.object3D), 
          true
        );
        
        if (intersects.length > 0) {
          const point = intersects[0].point;
          this.el.object3D.position.copy(point).add(this.offset);
        }
      },
      
      startDrag: function(intersection) {
        this.dragging = true;
        this.offset.copy(this.el.object3D.position).sub(intersection.point);
        this.el.setAttribute('material', 'opacity', 0.8);
      },
      
      endDrag: function() {
        this.dragging = false;
        this.el.setAttribute('material', 'opacity', 1);
        
        const tx = parseFloat(this.el.dataset.tx);
        const ty = parseFloat(this.el.dataset.ty);
        const pos = this.el.object3D.position;
        const dist = Math.hypot(pos.x - tx, pos.y - ty);

        if (dist < 0.1) {
          // –®–º–∞—Ç–æ—á–æ–∫ –Ω–∞ –º—ñ—Å—Ü—ñ
          this.el.object3D.position.set(tx, ty, 0.02);
          this.el.object3D.rotation.set(0, 0, 0);
          checkIfSolved(window.activeTarget);
        } else {
          // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–∞ –ø–æ—á–∞—Ç–∫–æ–≤—É –ø–æ–∑–∏—Ü—ñ—é
          const startPos = JSON.parse(this.el.dataset.startPos);
          this.el.setAttribute('animation', {
            property: 'position',
            to: `${startPos.x} ${startPos.y} 0.05`,
            dur: 400,
            easing: 'easeOutElastic'
          });
        }
      }
    });

    // === –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü ===
    let activeTarget = null;
    let puzzleStates = {};
    let solvedCount = 0;
    const imageCache = {};
    let lastMousePos = null;

    // === –û–ë–†–û–ë–ö–ê –ü–û–î–Ü–ô –ú–ò–®–Ü/–¢–ê–ß–£ ===
    document.addEventListener('mousemove', (e) => {
      lastMousePos = { x: e.clientX, y: e.clientY };
    });

    document.addEventListener('touchmove', (e) => {
      if (e.touches[0]) {
        lastMousePos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      }
    });

    // === –ü–û–ß–ê–¢–û–ö –ü–ï–†–ï–¢–Ø–ì–£–í–ê–ù–ù–Ø ===
    document.querySelector('a-scene').addEventListener('mousedown', (e) => {
      if (e.detail.intersectedEl && e.detail.intersectedEl.classList.contains('puzzle-piece')) {
        const dragComponent = e.detail.intersectedEl.components['drag-puzzle-piece'];
        if (dragComponent) {
          dragComponent.startDrag(e.detail.intersection);
        }
      }
    });

    document.querySelector('a-scene').addEventListener('touchstart', (e) => {
      if (e.detail.intersectedEl && e.detail.intersectedEl.classList.contains('puzzle-piece')) {
        const dragComponent = e.detail.intersectedEl.components['drag-puzzle-piece'];
        if (dragComponent) {
          dragComponent.startDrag(e.detail.intersection);
        }
      }
    });

    // === –ö–Ü–ù–ï–¶–¨ –ü–ï–†–ï–¢–Ø–ì–£–í–ê–ù–ù–Ø ===
    document.addEventListener('mouseup', () => {
      document.querySelectorAll('[drag-puzzle-piece]').forEach(el => {
        const comp = el.components['drag-puzzle-piece'];
        if (comp && comp.dragging) comp.endDrag();
      });
    });

    document.addEventListener('touchend', () => {
      document.querySelectorAll('[drag-puzzle-piece]').forEach(el => {
        const comp = el.components['drag-puzzle-piece'];
        if (comp && comp.dragging) comp.endDrag();
      });
    });

    // === –Ü–ù–®–Ü –§–£–ù–ö–¶–Ü–á –ó–ê–õ–ò–®–ê–Æ–¢–¨–°–Ø –ú–ê–ô–ñ–ï –ù–ï–ó–ú–Ü–ù–ï–ù–ò–ú–ò ===
    function createPuzzle(index) {
      const container = document.getElementById(`target-${index}`);
      if (puzzleStates[index]?.solved) { showSolved(index); return; }

      const url = `images/${String(index+1).padStart(2,'0')}.jpg?t=${Date.now()}`;
      if (imageCache[url]) { buildPieces(imageCache[url], index); return; }

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        const pieces = sliceImage(img);
        imageCache[url] = pieces;
        buildPieces(pieces, index);
      };
      img.onerror = () => buildFallback(index);
      img.src = url;
    }

    function sliceImage(img) {
      const pieces = [];
      const rows = 3, cols = 3;
      const pw = img.width / cols, ph = img.height / rows;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const canvas = document.createElement('canvas');
          canvas.width = pw; canvas.height = ph;
          canvas.getContext('2d').drawImage(img, c*pw, r*ph, pw, ph, 0, 0, pw, ph);
          pieces.push({
            src: canvas.toDataURL(),
            tx: (c - 1) * 0.27,
            ty: (1 - r) * 0.27
          });
        }
      }
      return pieces;
    }

    function buildPieces(piecesData, idx) {
      const container = document.getElementById(`target-${idx}`);
      container.innerHTML = '';
      const saved = puzzleStates[idx]?.positions || shuffle(piecesData);

      saved.forEach(p => {
        const plane = document.createElement('a-plane');
        plane.setAttribute('src', p.src);
        plane.setAttribute('width', 0.26);
        plane.setAttribute('height', 0.26);
        const startX = p.x || (Math.random()-0.5)*0.9;
        const startY = p.y || (Math.random()-0.5)*0.9;
        plane.setAttribute('position', `${startX} ${startY} 0.05`);
        plane.setAttribute('drag-puzzle-piece', '');
        plane.setAttribute('data-tx', p.tx);
        plane.setAttribute('data-ty', p.ty);
        plane.setAttribute('data-start-pos', JSON.stringify({x: startX, y: startY}));
        container.appendChild(plane);
      });

      puzzleStates[idx] = { positions: saved, solved: false };
    }

    function shuffle(arr) {
      const copy = arr.map(p => ({...p}));
      for (let i = copy.length-1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i+1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      copy.forEach(p => { p.x = (Math.random()-0.5)*1; p.y = (Math.random()-0.5)*1; });
      return copy;
    }

    function checkIfSolved(idx) {
      const pieces = document.querySelectorAll(`#target-${idx} a-plane`);
      const ok = Array.from(pieces).every(p => {
        const pos = p.object3D.position;
        return Math.abs(pos.x - parseFloat(p.dataset.tx)) < 0.08 &&
               Math.abs(pos.y - parseFloat(p.dataset.ty)) < 0.08;
      });

      if (ok && !puzzleStates[idx].solved) {
        puzzleStates[idx].solved = true;
        solvedCount++;
        document.getElementById('counter').textContent = `–ó—ñ–±—Ä–∞–Ω–æ: ${solvedCount} –∑ 12`;
        
        // –°–ø—Ä–æ–±–∞ –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤—É–∫
        try {
          document.getElementById('yay').src = `fon/${String(idx+1).padStart(2,'0')}.mp3`;
          document.getElementById('yay').play().catch(e => console.log('üîá –ó–≤—É–∫ –Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä–∏–≤—Å—è'));
        } catch(e) {}
        
        confetti({particleCount: 400, spread: 100});
        if (solvedCount === 12) setTimeout(() => document.getElementById('win').style.display='flex', 1200);
      }
    }

    function showSolved(idx) {
      const container = document.getElementById(`target-${idx}`);
      const img = document.createElement('a-image');
      img.setAttribute('src', `images/${String(idx+1).padStart(2,'0')}.jpg`);
      img.setAttribute('width', 0.8); img.setAttribute('height', 0.8);
      img.setAttribute('position', '0 0 0.01');
      container.appendChild(img);
    }

    function buildFallback(idx) {
      const container = document.getElementById(`target-${idx}`);
      for (let i = 0; i < 9; i++) {
        const box = document.createElement('a-box');
        box.setAttribute('color', `hsl(${i*40},100%,60%)`);
        box.setAttribute('width',0.2); box.setAttribute('height',0.2); box.setAttribute('depth',0.01);
        box.setAttribute('position', `${(Math.random()-0.5)*0.8} ${(Math.random()-0.5)*0.8} 0.05`);
        container.appendChild(box);
      }
    }

    // === –ó–ê–ü–£–°–ö –ö–ê–ú–ï–†–ò ===
    async function startAR() {
      try {
        // –°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º—É—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        
        // –ü–æ—Ç—ñ–º –∑–∞–ø—É—Å–∫–∞—î–º–æ MindAR
        const scene = document.querySelector('a-scene');
        const mindarSystem = scene.systems['mindar-image-system'];
        await mindarSystem.start();
        
        // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById('startButton').style.display = 'none';
        document.getElementById('hint').style.display = 'block';
        document.getElementById('counter').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        
      } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏:', err);
        alert('–î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ –¥–ª—è –≥—Ä–∏! üì±');
      }
    }

    // === –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ===
    document.querySelector('a-scene').addEventListener('loaded', () => {
      document.getElementById('loading').style.display = 'none';

      for (let i = 0; i < 12; i++) {
        const t = document.getElementById(`target-${i}`);
        t.addEventListener('targetFound', () => { 
          window.activeTarget = i; 
          createPuzzle(i); 
        });
        t.addEventListener('targetLost', () => { 
          if (window.activeTarget === i) window.activeTarget = null; 
        });
      }

      // –ó–∞–ø—É—Å–∫ –ø–æ –∫–Ω–æ–ø—Ü—ñ
      document.getElementById('startButton').addEventListener('click', startAR);
    });
  </script>
</body>
</html>
