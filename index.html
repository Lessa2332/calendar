<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>–ú–∞–≥—ñ—á–Ω–∏–π –ø–∞–∑–ª –¥–ª—è –∑—ñ—Ä–æ—á–∫–∏</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    body, html {margin:0; height:100%; overflow:hidden; background:#000; font-family:'Comic Sans MS',cursive,sans-serif;}
    
    /* –ö–ê–ú–ï–†–ê –í–ò–î–ù–û! */
    .mindar-ui-overlay, .mindar-ui-loading, .mindar-ui-scanning { display: none !important; }
    
    a-scene, .a-canvas {background:transparent !important;}

    #hint, #counter {
      position:fixed; padding:16px 32px; border-radius:50px; font-size:24px; z-index:999; color:#fff; box-shadow:0 0 30px #ff1493;
    }
    #hint {top:20px; left:50%; transform:translateX(-50%); background:#ff1493; text-align:center;}
    #counter {top:80px; left:20px; background:rgba(255,20,147,0.8);}
    
    #win {position:fixed; inset:0; background:rgba(0,0,0,0.97); color:gold; font-size:80px;
          display:none; align-items:center; justify-content:center; flex-direction:column; z-index:1000;}
    #win span {animation:bounce 1s infinite;}
    @keyframes bounce {0%,100%{transform:scale(1)} 50%{transform:scale(1.5)}}
    #loading {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:20px; z-index:1001;}
    
    #startButton {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#ff1493; color:white; border:none; padding:20px 40px;
      border-radius:50px; font-size:24px; cursor:pointer; z-index:1002;
      box-shadow:0 0 30px #ff1493;
    }
  </style>
</head>
<body>
  <div id="hint" style="display:none;">–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä –∫–∞–º–µ—Ä—ñ ‚Üí –ø–µ—Ä–µ—Ç—è–≥—É–π —à–º–∞—Ç–æ—á–∫–∏!</div>
  <div id="counter" style="display:none;">–ó—ñ–±—Ä–∞–Ω–æ: 0 –∑ 12</div>
  <div id="win"><span>–£–†–ê–ê–ê!</span><br>–¢–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π —á–∞—Ä—ñ–≤–Ω–∏–∫!</div>
  <div id="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –º–∞–≥—ñ—é...</div>
  <button id="startButton">üéÆ –ü–û–ß–ê–¢–ò –ì–†–£ üéÆ</button>

  <a-scene
    embedded
    mindar-image="imageTargetSrc: calendar.mind; filterMinCF:0.0001; filterBeta:0.01; autoStart: false; showBackground: true;"
    renderer="colorManagement: true; antialias: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-camera 
      raycaster="objects: .puzzle-piece; far: 100"
      cursor="fuse: false; rayOrigin: mouse">
    </a-camera>

    <!-- 12 –º–∞—Ä–∫–µ—Ä—ñ–≤ -->
    <a-entity id="target-0"  mindar-image-target="targetIndex: 0"></a-entity>
    <a-entity id="target-1"  mindar-image-target="targetIndex: 1"></a-entity>
    <a-entity id="target-2"  mindar-image-target="targetIndex: 2"></a-entity>
    <a-entity id="target-3"  mindar-image-target="targetIndex: 3"></a-entity>
    <a-entity id="target-4"  mindar-image-target="targetIndex: 4"></a-entity>
    <a-entity id="target-5"  mindar-image-target="targetIndex: 5"></a-entity>
    <a-entity id="target-6"  mindar-image-target="targetIndex: 6"></a-entity>
    <a-entity id="target-7"  mindar-image-target="targetIndex: 7"></a-entity>
    <a-entity id="target-8"  mindar-image-target="targetIndex: 8"></a-entity>
    <a-entity id="target-9"  mindar-image-target="targetIndex: 9"></a-entity>
    <a-entity id="target-10" mindar-image-target="targetIndex: 10"></a-entity>
    <a-entity id="target-11" mindar-image-target="targetIndex: 11"></a-entity>
  </a-scene>

  <audio id="yay" preload="auto"></audio>

  <script>
    // === –ü–†–û–°–¢–ò–ô DRAG COMPONENT ===
    AFRAME.registerComponent('drag-puzzle-piece', {
      init: function () {
        this.el.classList.add('puzzle-piece');
        this.dragging = false;
        this.startPosition = new THREE.Vector3();
        this.mouseStart = new THREE.Vector2();
      },
      
      events: {
        mousedown: function (evt) {
          if (!window.activeTarget) return;
          this.dragging = true;
          this.startPosition.copy(this.el.object3D.position);
          this.mouseStart.set(evt.detail.intersection.uv.x, evt.detail.intersection.uv.y);
          this.el.setAttribute('material', 'opacity', 0.8);
          document.querySelector('a-scene').setAttribute('cursor', 'fuse: false');
        },
        
        touchstart: function (evt) {
          this.events.mousedown.call(this, evt);
        }
      },
      
      tick: function() {
        if (!this.dragging || !window.lastMousePos) return;
        
        // –û—Ç—Ä–∏–º—É—î–º–æ —Ä—ñ–∑–Ω–∏—Ü—é —Ä—É—Ö—É –º–∏—à—ñ
        const camera = document.querySelector('[camera]').object3D;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        mouse.x = (window.lastMousePos.x / window.innerWidth) * 2 - 1;
        mouse.y = - (window.lastMousePos.y / window.innerHeight) * 2 + 1;
        
        raycaster.setFromCamera(mouse, camera);
        
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø–ª–æ—â–∏–Ω—É –¥–ª—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è
        const plane = new THREE.Plane(new THREE.Vector3(0, 0, 1), 0.05);
        const intersectionPoint = new THREE.Vector3();
        raycaster.ray.intersectPlane(plane, intersectionPoint);
        
        if (intersectionPoint) {
          this.el.object3D.position.copy(intersectionPoint);
        }
      },
      
      remove: function() {
        this.dragging = false;
        document.querySelector('a-scene').setAttribute('cursor', 'fuse: true');
      }
    });

    // === –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü ===
    let activeTarget = null;
    let puzzleStates = {};
    let solvedCount = 0;
    const imageCache = {};
    let lastMousePos = null;

    // === –û–ë–†–û–ë–ö–ê –ü–û–î–Ü–ô –ú–ò–®–Ü/–¢–ê–ß–£ ===
    document.addEventListener('mousemove', (e) => {
      lastMousePos = { x: e.clientX, y: e.clientY };
    });

    document.addEventListener('touchmove', (e) => {
      if (e.touches[0]) {
        lastMousePos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        e.preventDefault();
      }
    }, { passive: false });

    // === –ö–Ü–ù–ï–¶–¨ –ü–ï–†–ï–¢–Ø–ì–£–í–ê–ù–ù–Ø ===
    document.addEventListener('mouseup', () => {
      const pieces = document.querySelectorAll('.puzzle-piece');
      pieces.forEach(piece => {
        const comp = piece.components['drag-puzzle-piece'];
        if (comp && comp.dragging) {
          comp.dragging = false;
          piece.setAttribute('material', 'opacity', 1);
          document.querySelector('a-scene').setAttribute('cursor', 'fuse: true');
          
          // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —à–º–∞—Ç–æ—á–æ–∫ –Ω–∞ –º—ñ—Å—Ü—ñ
          const tx = parseFloat(piece.dataset.tx);
          const ty = parseFloat(piece.dataset.ty);
          const pos = piece.object3D.position;
          const dist = Math.hypot(pos.x - tx, pos.y - ty);

          if (dist < 0.08) {
            // –®–º–∞—Ç–æ—á–æ–∫ –Ω–∞ –º—ñ—Å—Ü—ñ
            piece.object3D.position.set(tx, ty, 0.02);
            piece.object3D.rotation.set(0, 0, 0);
            checkIfSolved(window.activeTarget);
          } else {
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–∞ –ø–æ—á–∞—Ç–∫–æ–≤—É –ø–æ–∑–∏—Ü—ñ—é
            piece.setAttribute('animation', {
              property: 'position',
              to: `${comp.startPosition.x} ${comp.startPosition.y} 0.05`,
              dur: 500,
              easing: 'easeOutElastic'
            });
          }
        }
      });
    });

    document.addEventListener('touchend', () => {
      document.dispatchEvent(new Event('mouseup'));
    });

    // === –°–¢–í–û–†–ï–ù–ù–Ø –ü–ê–ó–õ–£ ===
    function createPuzzle(index) {
      const container = document.getElementById(`target-${index}`);
      if (puzzleStates[index]?.solved) { 
        showSolved(index); 
        return; 
      }

      const url = `images/${String(index+1).padStart(2,'0')}.jpg?t=${Date.now()}`;
      if (imageCache[url]) { 
        buildPieces(imageCache[url], index); 
        return; 
      }

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        const pieces = sliceImage(img);
        imageCache[url] = pieces;
        buildPieces(pieces, index);
      };
      img.onerror = () => buildFallback(index);
      img.src = url;
    }

    function sliceImage(img) {
      const pieces = [];
      const rows = 3, cols = 3;
      const pieceWidth = 0.26;
      const pieceHeight = (img.height / img.width) * pieceWidth;
      const spacing = 0.01;
      
      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // –†–æ–∑–º—ñ—Ä–∏ —à–º–∞—Ç–æ—á–∫–∞
          const srcWidth = img.width / cols;
          const srcHeight = img.height / rows;
          
          canvas.width = srcWidth;
          canvas.height = srcHeight;
          
          // –í–∏—Ä—ñ–∑–∞—î–º–æ —à–º–∞—Ç–æ—á–æ–∫
          ctx.drawImage(
            img,
            col * srcWidth, row * srcHeight, srcWidth, srcHeight,
            0, 0, srcWidth, srcHeight
          );
          
          // –¶—ñ–ª—å–æ–≤–∞ –ø–æ–∑–∏—Ü—ñ—è (–∑—ñ–±—Ä–∞–Ω–∏–π –ø–∞–∑–ª)
          const targetX = (col - 1) * (pieceWidth + spacing);
          const targetY = (1 - row) * (pieceHeight + spacing);
          
          pieces.push({
            src: canvas.toDataURL(),
            tx: targetX,
            ty: targetY,
            width: pieceWidth,
            height: pieceHeight
          });
        }
      }
      return pieces;
    }

    function buildPieces(piecesData, idx) {
      const container = document.getElementById(`target-${idx}`);
      container.innerHTML = '';
      
      // –û—Ç—Ä–∏–º—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω –∞–±–æ –ø–µ—Ä–µ–º—ñ—à—É—î–º–æ
      const savedState = puzzleStates[idx]?.positions || shufflePieces(piecesData);

      savedState.forEach((pieceData, index) => {
        const plane = document.createElement('a-plane');
        plane.setAttribute('src', pieceData.src);
        plane.setAttribute('width', pieceData.width);
        plane.setAttribute('height', pieceData.height);
        plane.setAttribute('position', `${pieceData.x} ${pieceData.y} 0.05`);
        plane.setAttribute('drag-puzzle-piece', '');
        plane.setAttribute('data-tx', pieceData.tx);
        plane.setAttribute('data-ty', pieceData.ty);
        plane.setAttribute('data-index', index);
        container.appendChild(plane);
      });

      puzzleStates[idx] = { 
        positions: savedState, 
        solved: false 
      };
    }

    function shufflePieces(pieces) {
      const shuffled = [...pieces];
      
      // –ü–µ—Ä–µ–º—ñ—à—É—î–º–æ –ø–æ–∑–∏—Ü—ñ—ó
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      
      // –î–æ–¥–∞—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤—ñ –ø–æ–∑–∏—Ü—ñ—ó –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —à–º–∞—Ç–æ—á–∫–∞
      shuffled.forEach((piece, index) => {
        piece.x = (Math.random() - 0.5) * 1.2; // -0.6 –¥–æ +0.6
        piece.y = (Math.random() - 0.5) * 1.2; // -0.6 –¥–æ +0.6
      });
      
      return shuffled;
    }

    function checkIfSolved(idx) {
      if (!window.activeTarget || activeTarget !== idx) return;
      
      const pieces = document.querySelectorAll(`#target-${idx} .puzzle-piece`);
      let allCorrect = true;
      
      pieces.forEach(piece => {
        const pos = piece.object3D.position;
        const targetX = parseFloat(piece.dataset.tx);
        const targetY = parseFloat(piece.dataset.ty);
        const dist = Math.hypot(pos.x - targetX, pos.y - targetY);
        
        if (dist >= 0.08) {
          allCorrect = false;
        }
      });

      if (allCorrect && !puzzleStates[idx].solved) {
        puzzleStates[idx].solved = true;
        solvedCount++;
        document.getElementById('counter').textContent = `–ó—ñ–±—Ä–∞–Ω–æ: ${solvedCount} –∑ 12`;
        
        // –°–ø—Ä–æ–±–∞ –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤—É–∫
        try {
          const audio = document.getElementById('yay');
          audio.src = `fon/${String(idx+1).padStart(2,'0')}.mp3`;
          audio.play().catch(e => console.log('üîá –ó–≤—É–∫ –Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä–∏–≤—Å—è'));
        } catch(e) {}
        
        // –ö–æ–Ω—Ñ–µ—Ç—Ç—ñ
        confetti({
          particleCount: 150,
          spread: 70,
          origin: { y: 0.6 }
        });
        
        if (solvedCount === 12) {
          setTimeout(() => {
            document.getElementById('win').style.display = 'flex';
          }, 1000);
        }
      }
    }

    function showSolved(idx) {
      const container = document.getElementById(`target-${idx}`);
      container.innerHTML = '';
      
      const img = document.createElement('a-image');
      img.setAttribute('src', `images/${String(idx+1).padStart(2,'0')}.jpg`);
      img.setAttribute('width', 0.8);
      img.setAttribute('height', 0.6);
      img.setAttribute('position', '0 0 0.01');
      container.appendChild(img);
    }

    function buildFallback(idx) {
      const container = document.getElementById(`target-${idx}`);
      container.innerHTML = '';
      
      for (let i = 0; i < 9; i++) {
        const box = document.createElement('a-box');
        box.setAttribute('color', `hsl(${i*40}, 100%, 60%)`);
        box.setAttribute('width', 0.2);
        box.setAttribute('height', 0.2);
        box.setAttribute('depth', 0.01);
        box.setAttribute('position', `${(Math.random()-0.5)*1} ${(Math.random()-0.5)*1} 0.05`);
        box.setAttribute('drag-puzzle-piece', '');
        box.setAttribute('data-tx', ((i % 3) - 1) * 0.25);
        box.setAttribute('data-ty', (1 - Math.floor(i / 3)) * 0.25);
        container.appendChild(box);
      }
    }

    // === –ó–ê–ü–£–°–ö –ö–ê–ú–ï–†–ò ===
    async function startAR() {
      try {
        // –°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º—É—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        
        // –ü–æ—Ç—ñ–º –∑–∞–ø—É—Å–∫–∞—î–º–æ MindAR
        const scene = document.querySelector('a-scene');
        const mindarSystem = scene.systems['mindar-image-system'];
        await mindarSystem.start();
        
        // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById('startButton').style.display = 'none';
        document.getElementById('hint').style.display = 'block';
        document.getElementById('counter').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        
      } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏:', err);
        alert('–î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ –¥–ª—è –≥—Ä–∏! üì±\n\n–ü–æ—Ç—ñ–º –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂ —Å—Ç–æ—Ä—ñ–Ω–∫—É.');
      }
    }

    // === –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ===
    document.querySelector('a-scene').addEventListener('loaded', () => {
      document.getElementById('loading').style.display = 'none';

      // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –º–∞—Ä–∫–µ—Ä—ñ–≤
      for (let i = 0; i < 12; i++) {
        const target = document.getElementById(`target-${i}`);
        target.addEventListener('targetFound', (e) => { 
          window.activeTarget = i; 
          createPuzzle(i);
        });
        target.addEventListener('targetLost', (e) => { 
          if (window.activeTarget === i) window.activeTarget = null; 
        });
      }

      // –ó–∞–ø—É—Å–∫ –ø–æ –∫–Ω–æ–ø—Ü—ñ
      document.getElementById('startButton').addEventListener('click', startAR);
    });
  </script>
</body>
</html>
