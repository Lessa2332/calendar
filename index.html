<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Магічний пазл для зірочки</title>

  <!-- ✅ ЄДИНА робоча комбінація 2025: без eval, з правильним MIME -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    body, html { margin:0; height:100%; overflow:hidden; background:#000; font-family:'Comic Sans MS',cursive,sans-serif; }
    #hint {
      position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:#ff1493; color:#fff; padding:16px 32px; border-radius:50px;
      font-size:24px; z-index:999; box-shadow:0 0 30px #ff1493; text-align:center;
    }
    #win {
      position:fixed; inset:0; background:rgba(0,0,0,0.97); color:gold; font-size:80px;
      display:none; align-items:center; justify-content:center; flex-direction:column;
      z-index:1000; text-align:center;
    }
    #win span { animation:bounce 1s infinite; }
    @keyframes bounce { 0%,100%{transform:scale(1)} 50%{transform:scale(1.5)} }
  </style>
</head>
<body>

  <div id="hint">Натисни екран → покажи маркер → збирай пазл!</div>
  <div id="win"><span>УРААА!</span><br>Ти найкращий чарівник!</div>

  <a-scene
    embedded
    mindar-image="imageTargetSrc: ./calendar.mind; autoStart:false; uiLoading:no; uiError:no; uiScanning:no; filterMinCF:0.0001; filterBeta:1000; warmupTolerance:5"
    renderer="colorManagement:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false">
    <a-camera></a-camera>
    <a-entity id="targets-container"></a-entity>
  </a-scene>

  <audio id="yay" crossorigin="anonymous" preload="auto"
         src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3"></audio>

  <script>
    let activeTargetIndex = null;
    let clickHandler = null;

    // Створюємо 12 цілей
    function createTargets() {
      const container = document.getElementById('targets-container');
      for (let i = 0; i < 12; i++) {
        const target = document.createElement('a-entity');
        target.setAttribute('mindar-image-target', { targetIndex: i });
        target.id = `target-${i}`;
        container.appendChild(target);
      }
    }

    // Запуск AR
    function startAR() {
      const scene = document.querySelector('a-scene');
      const mindarSystem = scene.systems['mindar-image-system']; // ✅ Правильна назва для v1.2.5
      if (mindarSystem) mindarSystem.start();
      document.getElementById('hint').textContent = 'Шукаю маркер...';
    }

    function onTargetFound(e) {
      const idx = e.detail.targetIndex;
      if (activeTargetIndex === idx) return;
      resetPuzzle();
      activeTargetIndex = idx;
      setTimeout(() => createPuzzle(idx), 600);
    }

    function onTargetLost() {
      if (activeTargetIndex !== null) resetPuzzle();
    }

    function resetPuzzle() {
      if (clickHandler) {
        document.querySelector('a-scene').removeEventListener('click', clickHandler);
        clickHandler = null;
      }
      for (let i = 0; i < 12; i++) {
        const el = document.getElementById(`target-${i}`);
        if (el) el.innerHTML = '';
      }
      activeTargetIndex = null;
      document.getElementById('win').style.display = 'none';
    }

    async function createPuzzle(targetIndex) {
      const img = new Image();
      img.src = `./images/${String(targetIndex + 1).padStart(2, '0')}.jpg?t=${Date.now()}`;
      await new Promise((res, rej) => {
        img.onload = res;
        img.onerror = () => rej(`Помилка завантаження зображення ${targetIndex + 1}`);
      });

      const pieceW = img.width / 3;
      const pieceH = img.height / 3;
      const scaleW = 0.5 / 3;
      const scaleH = (img.height / img.width) * 0.5 / 3;
      const container = document.getElementById(`target-${targetIndex}`);
      const pieces = [];

      // Створюємо 9 шматочків
      for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 3; col++) {
          const canvas = document.createElement('canvas');
          canvas.width = pieceW;
          canvas.height = pieceH;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, col * pieceW, row * pieceH, pieceW, pieceH, 0, 0, pieceW, pieceH);

          const plane = document.createElement('a-plane');
          plane.setAttribute('src', canvas.toDataURL('image/jpeg', 0.9));
          plane.setAttribute('width', scaleW * 2);
          plane.setAttribute('height', scaleH * 2);
          plane.setAttribute('position', `${(Math.random() - 0.5) * 1.5} ${(Math.random() - 0.5) * 1.5} 0.02`);
          plane.setAttribute('data-target-x', (col - 1) * scaleW);
          plane.setAttribute('data-target-y', (1 - row) * scaleH);
          plane.classList.add('piece');
          container.appendChild(plane);
          pieces.push(plane);
        }
      }

      // Перемішуємо (20 ітерацій для кращого ефекту)
      for (let i = 0; i < 20; i++) {
        const a = Math.floor(Math.random() * 9);
        const b = Math.floor(Math.random() * 9);
        const posA = pieces[a].getAttribute('position');
        const posB = pieces[b].getAttribute('position');
        pieces[a].setAttribute('position', posB);
        pieces[b].setAttribute('position', posA);
      }

      // Обробник кліків
      clickHandler = (e) => {
        const piece = e.detail.intersectedEl;
        if (!piece || !piece.classList.contains('piece')) return;

        const others = pieces.filter(p => p !== piece);
        const swapWith = others[Math.floor(Math.random() * others.length)];

        const tmp = piece.getAttribute('position');
        piece.setAttribute('position', swapWith.getAttribute('position'));
        swapWith.setAttribute('position', tmp);

        // Перевірка перемоги (допуск 0.09 для стабільності)
        const solved = pieces.every(p => {
          const pos = p.getAttribute('position');
          const tx = parseFloat(p.getAttribute('data-target-x'));
          const ty = parseFloat(p.getAttribute('data-target-y'));
          return Math.abs(pos.x - tx) < 0.09 && Math.abs(pos.y - ty) < 0.09;
        });

        if (solved) {
          document.getElementById('win').style.display = 'flex';
          document.getElementById('yay').play().catch(() => {});
          confetti({ particleCount: 800, spread: 130, origin: { y: 0.6 } });
          document.querySelector('a-scene').removeEventListener('click', clickHandler);
          clickHandler = null;
        }
      };

      document.querySelector('a-scene').addEventListener('click', clickHandler);
    }

    // Ініціалізація після завантаження A-Frame
    document.querySelector('a-scene').addEventListener('loaded', () => {
      createTargets();
      const sceneEl = document.querySelector('a-scene');
      sceneEl.addEventListener('targetFound', onTargetFound);
      sceneEl.addEventListener('targetLost', onTargetLost);
      document.body.addEventListener('click', startAR, { once: true });
      document.getElementById('hint').textContent = 'Готово! Натисни екран і покажи маркер ✨';
    });
  </script>
</body>
</html>
