<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>–ú–∞–≥—ñ—á–Ω–∏–π –ø–∞–∑–ª –¥–ª—è –∑—ñ—Ä–æ—á–∫–∏</title>

  <!-- ‚úÖ –Ø–∫ —É –ø–∏—Å–∞–Ω—Ü—ñ: MindAR 1.2.2 -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    body, html { margin:0; height:100%; overflow:hidden; background:#000; font-family:'Comic Sans MS',cursive,sans-serif; }
    #hint {
      position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:#ff1493; color:#fff; padding:16px 32px; border-radius:50px;
      font-size:24px; z-index:999; box-shadow:0 0 30px #ff1493; text-align:center;
    }
    #win {
      position:fixed; inset:0; background:rgba(0,0,0,0.97); color:gold; font-size:80px;
      display:none; align-items:center; justify-content:center; flex-direction:column;
      z-index:1000; text-align:center;
    }
    #win span { animation:bounce 1s infinite; }
    @keyframes bounce { 0%,100%{transform:scale(1)} 50%{transform:scale(1.5)} }
    
    #loading {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      color:#fff; font-size:20px; z-index:1001; text-align:center;
    }
  </style>
</head>
<body>

  <div id="hint">–ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –µ–∫—Ä–∞–Ω ‚Üí –ø–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä ‚Üí –∑–±–∏—Ä–∞–π –ø–∞–∑–ª!</div>
  <div id="win"><span>–£–†–ê–ê–ê!</span><br>–¢–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π —á–∞—Ä—ñ–≤–Ω–∏–∫!</div>
  <div id="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

  <!-- ‚úÖ –Ø–∫ —É –ø–∏—Å–∞–Ω—Ü—ñ: –ø—Ä–æ—Å—Ç–∏–π –∞—Ç—Ä–∏–±—É—Ç –±–µ–∑ –∑–∞–π–≤–æ–≥–æ -->
  <a-scene
    mindar-image="imageTargetSrc: ./calendar.mind;"
    renderer="colorManagement: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-camera></a-camera>
    <a-entity id="targets-container"></a-entity>
  </a-scene>

  <audio id="yay" preload="auto">
    <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
  </audio>

  <script>
    let activeTargetIndex = null;
    let clickHandler = null;
    let targetsCreated = false;
    let userInteracted = false;

    function unlockAudio() {
      if (userInteracted) return;
      userInteracted = true;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      ctx.resume();
      const sounds = document.querySelectorAll('audio');
      sounds.forEach(s => { s.play().catch(()=>{}); s.pause(); s.currentTime = 0; });
    }

    function createTargets() {
      if (targetsCreated) return;
      const container = document.getElementById('targets-container');
      for (let i = 0; i < 12; i++) {
        const target = document.createElement('a-entity');
        target.setAttribute('mindar-image-target', { targetIndex: i });
        target.id = `target-${i}`;
        
        // ‚úÖ –Ø–∫ —É –ø–∏—Å–∞–Ω—Ü—ñ: –ø–æ–¥—ñ—ó —Å–ª—É—Ö–∞—î–º–æ –Ω–∞ —Å–∞–º—ñ–π —Ü—ñ–ª—ñ
        target.addEventListener('targetFound', onTargetFound);
        target.addEventListener('targetLost', onTargetLost);
        
        container.appendChild(target);
      }
      targetsCreated = true;
      console.log('‚úÖ –¶—ñ–ª—ñ —Å—Ç–≤–æ—Ä–µ–Ω—ñ');
    }

    function resetPuzzle() {
      if (clickHandler) {
        document.querySelector('a-scene').removeEventListener('click', clickHandler);
        clickHandler = null;
      }
      for (let i = 0; i < 12; i++) {
        const el = document.getElementById(`target-${i}`);
        if (el) el.innerHTML = '';
      }
      activeTargetIndex = null;
      document.getElementById('win').style.display = 'none';
    }

    function createPuzzle(targetIndex) {
      const container = document.getElementById(`target-${targetIndex}`);
      if (!container) return;

      const pieces = [];
      const rows = 3, cols = 3;
      const scale = 0.15;
      const spacing = 0.02;

      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const piece = document.createElement('a-box');
          const hue = (row * cols + col) * 40;
          piece.setAttribute('color', `hsl(${hue}, 100%, 50%)`);
          piece.setAttribute('depth', 0.01);
          piece.setAttribute('width', scale);
          piece.setAttribute('height', scale);

          const targetX = (col - 1) * (scale + spacing);
          const targetY = (1 - row) * (scale + spacing);
          const startX = (Math.random() - 0.5) * 0.8;
          const startY = (Math.random() - 0.5) * 0.8;

          piece.setAttribute('position', { x: startX, y: startY, z: 0.05 });
          piece.setAttribute('data-target-x', targetX);
          piece.setAttribute('data-target-y', targetY);
          piece.setAttribute('data-target-z', 0.02);
          piece.classList.add('piece');

          const text = document.createElement('a-text');
          text.setAttribute('value', `${row * cols + col + 1}`);
          text.setAttribute('align', 'center');
          text.setAttribute('color', '#fff');
          text.setAttribute('position', '0 0 0.006');
          text.setAttribute('scale', '0.2 0.2 0.2');
          piece.appendChild(text);

          container.appendChild(piece);
          pieces.push(piece);
        }
      }

      clickHandler = (e) => {
        const piece = e.detail.intersectedEl;
        if (!piece || !piece.classList.contains('piece')) return;

        const otherPieces = pieces.filter(p => p !== piece);
        if (otherPieces.length === 0) return;

        const swapPiece = otherPieces[Math.floor(Math.random() * otherPieces.length)];
        const tempPos = piece.getAttribute('position');
        piece.setAttribute('position', swapPiece.getAttribute('position'));
        swapPiece.setAttribute('position', tempPos);

        checkPuzzleSolved(pieces);
      };

      document.querySelector('a-scene').addEventListener('click', clickHandler);
      console.log(`‚úÖ –ü–∞–∑–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ –¥–ª—è —Ü—ñ–ª—ñ ${targetIndex}`);
    }

    function checkPuzzleSolved(pieces) {
      const solved = pieces.every(piece => {
        const pos = piece.getAttribute('position');
        const targetX = parseFloat(piece.getAttribute('data-target-x'));
        const targetY = parseFloat(piece.getAttribute('data-target-y'));
        const targetZ = parseFloat(piece.getAttribute('data-target-z'));
        return Math.abs(pos.x - targetX) < 0.05 && 
               Math.abs(pos.y - targetY) < 0.05 && 
               Math.abs(pos.z - targetZ) < 0.05;
      });

      if (solved) {
        console.log('üéâ –ü–∞–∑–ª –∑—ñ–±—Ä–∞–Ω–æ!');
        document.getElementById('win').style.display = 'flex';

        const audio = document.getElementById('yay');
        audio.play().catch(e => console.log('üîá –ó–≤—É–∫ –Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–æ:', e));

        confetti({ 
          particleCount: 300, 
          spread: 100, 
          origin: { y: 0.6 },
          colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff']
        });

        if (clickHandler) {
          document.querySelector('a-scene').removeEventListener('click', clickHandler);
          clickHandler = null;
        }
      }
    }

    // ‚úÖ –ë–µ–∑–ø–µ—á–Ω—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏ (—è–∫ —É –ø–∏—Å–∞–Ω—Ü—ñ)
    function onTargetFound(e) {
      if (!e?.detail?.targetIndex && e?.detail?.targetIndex !== 0) return;
      const idx = e.detail.targetIndex;
      console.log(`üéØ –ó–Ω–∞–π–¥–µ–Ω–æ —Ü—ñ–ª—å: ${idx}`);
      if (activeTargetIndex === idx) return;
      resetPuzzle();
      activeTargetIndex = idx;
      setTimeout(() => createPuzzle(idx), 300);
    }

    function onTargetLost(e) {
      if (!e?.detail?.targetIndex && e?.detail?.targetIndex !== 0) return;
      console.log(`‚ùå –í—Ç—Ä–∞—á–µ–Ω–æ —Ü—ñ–ª—å: ${e.detail.targetIndex}`);
      if (activeTargetIndex === e.detail.targetIndex) {
        resetPuzzle();
      }
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    document.querySelector('a-scene').addEventListener('loaded', () => {
      console.log('üé¨ –°—Ü–µ–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
      createTargets();

      // ‚ùå –ù–ï –¥–æ–¥–∞—î–º–æ –ø–æ–¥—ñ—ó –¥–æ —Å—Ü–µ–Ω–∏ ‚Äî —Ç—ñ–ª—å–∫–∏ –¥–æ —Ü—ñ–ª–µ–π (–≤–∂–µ –∑—Ä–æ–±–ª–µ–Ω–æ –≤ createTargets)

      document.body.addEventListener('click', unlockAudio, { once: true });

      document.getElementById('loading').style.display = 'none';
      document.getElementById('hint').textContent = '–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä –∫–∞–º–µ—Ä—ñ! üì±';
    });

    window.addEventListener('beforeunload', resetPuzzle);
  </script>
</body>
</html>
