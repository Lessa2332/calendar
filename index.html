<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Магічний пазл для зірочки</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    body, html {margin:0; height:100%; overflow:hidden; background:#000; font-family:'Comic Sans MS',cursive,sans-serif;}
    
    /* КАМЕРА ВИДНО! */
    .mindar-video-container video, video, canvas + video {
      display: block !important; position: fixed !important; top:0; left:0; width:100% !important; height:100% !important;
      object-fit: cover !important; z-index:-2 !important;
    }
    a-scene, .a-canvas {background:transparent !important;}

    #hint, #counter {
      position:fixed; padding:16px 32px; border-radius:50px; font-size:24px; z-index:999; color:#fff; box-shadow:0 0 30px #ff1493;
    }
    #hint {top:20px; left:50%; transform:translateX(-50%); background:#ff1493;}
    #counter {top:80px; left:20px; background:rgba(255,20,147,0.8);}
    
    #win {position:fixed; inset:0; background:rgba(0,0,0,0.97); color:gold; font-size:80px;
          display:none; align-items:center; justify-content:center; flex-direction:column; z-index:1000;}
    #win span {animation:bounce 1s infinite;}
    @keyframes bounce {0%,100%{transform:scale(1)} 50%{transform:scale(1.5)}}
    #loading {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:20px; z-index:1001;}
  </style>
</head>
<body>
  <div id="hint">Покажи маркер камері → перетягуй шматочки!</div>
  <div id="counter">Зібрано: 0 з 12</div>
  <div id="win"><span>УРААА!</span><br>Ти найкращий чарівник!</div>
  <div id="loading">Завантажуємо магію...</div>

  <a-scene
    embedded
    mindar-image="imageTargetSrc: calendar.mind; filterMinCF:0.0001; filterBeta:0.01;"
    renderer="colorManagement: true; antialias: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <!-- ВКЛЮЧАЄМО ФОН КАМЕРИ -->
    <a-entity mindar-image-system="showBackground: true;"></a-entity>
    <a-camera></a-camera>

    <!-- 12 маркерів -->
    <a-entity id="target-0"  mindar-image-target="targetIndex: 0"></a-entity>
    <a-entity id="target-1"  mindar-image-target="targetIndex: 1"></a-entity>
    <a-entity id="target-2"  mindar-image-target="targetIndex: 2"></a-entity>
    <a-entity id="target-3"  mindar-image-target="targetIndex: 3"></a-entity>
    <a-entity id="target-4"  mindar-image-target="targetIndex: 4"></a-entity>
    <a-entity id="target-5"  mindar-image-target="targetIndex: 5"></a-entity>
    <a-entity id="target-6"  mindar-image-target="targetIndex: 6"></a-entity>
    <a-entity id="target-7"  mindar-image-target="targetIndex: 7"></a-entity>
    <a-entity id="target-8"  mindar-image-target="targetIndex: 8"></a-entity>
    <a-entity id="target-9"  mindar-image-target="targetIndex: 9"></a-entity>
    <a-entity id="target-10" mindar-image-target="targetIndex: 10"></a-entity>
    <a-entity id="target-11" mindar-image-target="targetIndex: 11"></a-entity>
  </a-scene>

  <audio id="yay" preload="auto"></audio>

  <script>
    AFRAME.registerComponent('drag-puzzle-piece', {
      init: function () {
        const el = this.el;
        let startPos = null;
        let currentTarget = null;

        const start = (e) => {
          if (activeTarget === null || puzzleStates[activeTarget]?.solved) return;
          e.preventDefault();
          startPos = el.getAttribute('position');
          currentTarget = activeTarget;
          el.setAttribute('material', 'opacity', 0.8);
        };

        const move = (e) => {
          if (currentTarget !== activeTarget) return;
          const touch = e.touches ? e.touches[0] : e;
          const hit = document.querySelector('a-scene').systems['mindar-image-system'].getHitPoint(touch.clientX, touch.clientY);
          if (hit) el.setAttribute('position', {x: hit.x, y: hit.y, z: 0.05});
        };

        const end = () => {
          if (currentTarget !== activeTarget) return;
          el.setAttribute('material', 'opacity', 1);

          const tx = parseFloat(el.dataset.tx);
          const ty = parseFloat(el.dataset.ty);
          const pos = el.getAttribute('position');
          const dist = Math.hypot(pos.x - tx, pos.y - ty);

          if (dist < 0.1) {
            el.setAttribute('position', {x: tx, y: ty, z: 0.02});
            el.setAttribute('rotation', '0 0 0');
            el.emit('snap');
          } else {
            el.setAttribute('animation', `property: position; to: ${startPos.x} ${startPos.y} 0.05; dur: 400; easing: easeOutElastic`);
          }
          checkIfSolved(activeTarget);
        };

        el.addEventListener('mousedown', start);
        el.addEventListener('touchstart', start);
        document.addEventListener('mousemove', move);
        document.addEventListener('touchmove', move);
        document.addEventListener('mouseup', end);
        document.addEventListener('touchend', end);
      }
    });

    let activeTarget = null;
    let puzzleStates = {};
    let solvedCount = 0;
    const imageCache = {};

    function createPuzzle(index) {
      const container = document.getElementById(`target-${index}`);
      if (puzzleStates[index]?.solved) { showSolved(index); return; }

      const url = `images/${String(index+1).padStart(2,'0')}.jpg?t=${Date.now()}`;
      if (imageCache[url]) { buildPieces(imageCache[url], index); return; }

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        const pieces = sliceImage(img);
        imageCache[url] = pieces;
        buildPieces(pieces, index);
      };
      img.onerror = () => buildFallback(index);
      img.src = url;
    }

    function sliceImage(img) {
      const pieces = [];
      const rows = 3, cols = 3;
      const pw = img.width / cols, ph = img.height / rows;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const canvas = document.createElement('canvas');
          canvas.width = pw; canvas.height = ph;
          canvas.getContext('2d').drawImage(img, c*pw, r*ph, pw, ph, 0, 0, pw, ph);
          pieces.push({
            src: canvas.toDataURL(),
            tx: (c - 1) * 0.27,     // від -0.54 до +0.54 → гарний розмір
            ty: (1 - r) * 0.27      // від +0.54 до -0.54
          });
        }
      }
      return pieces;
    }

    function buildPieces(piecesData, idx) {
      const container = document.getElementById(`target-${idx}`);
      container.innerHTML = '';
      const saved = puzzleStates[idx]?.positions || shuffle(piecesData);

      saved.forEach(p => {
        const plane = document.createElement('a-plane');
        plane.setAttribute('src', p.src);
        plane.setAttribute('width', 0.26);
        plane.setAttribute('height', 0.26);
        plane.setAttribute('position', `${p.x || (Math.random()-0.5)*0.9} ${p.y || (Math.random()-0.5)*0.9} 0.05`);
        plane.setAttribute('drag-puzzle-piece', '');
        plane.setAttribute('data-tx', p.tx);
        plane.setAttribute('data-ty', p.ty);
        plane.classList.add('clickable');
        container.appendChild(plane);
      });

      puzzleStates[idx] = { positions: saved, solved: false };
    }

    function shuffle(arr) {
      const copy = arr.map(p => ({...p}));
      for (let i = copy.length-1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i+1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      copy.forEach(p => { p.x = (Math.random()-0.5)*1; p.y = (Math.random()-0.5)*1; });
      return copy;
    }

    function checkIfSolved(idx) {
      const pieces = document.querySelectorAll(`#target-${idx} a-plane`);
      const ok = Array.from(pieces).every(p => {
        const pos = p.getAttribute('position');
        return Math.abs(pos.x - parseFloat(p.dataset.tx)) < 0.08 &&
               Math.abs(pos.y - parseFloat(p.dataset.ty)) < 0.08;
      });

      if (ok && !puzzleStates[idx].solved) {
        puzzleStates[idx].solved = true;
        solvedCount++;
        document.getElementById('counter').textContent = `Зібрано: ${solvedCount} з 12`;
        document.getElementById('yay').src = `fon/${String(idx+1).padStart(2,'0')}.mp3`;
        document.getElementById('yay').play();
        confetti({particleCount: 400, spread: 100});
        if (solvedCount === 12) setTimeout(() => document.getElementById('win').style.display='flex', 1200);
      }
    }

    function showSolved(idx) {
      const container = document.getElementById(`target-${idx}`);
      const img = document.createElement('a-image');
      img.setAttribute('src', `images/${String(idx+1).padStart(2,'0')}.jpg`);
      img.setAttribute('width', 0.8); img.setAttribute('height', 0.8);
      img.setAttribute('position', '0 0 0.01');
      container.appendChild(img);
    }

    function buildFallback(idx) {
      // прості кольорові квадратики як резерв
      const container = document.getElementById(`target-${idx}`);
      for (let i = 0; i < 9; i++) {
        const box = document.createElement('a-box');
        box.setAttribute('color', `hsl(${i*40},100%,60%)`);
        box.setAttribute('width',0.2); box.setAttribute('height',0.2); box.setAttribute('depth',0.01);
        box.setAttribute('position', `${(Math.random()-0.5)*0.8} ${(Math.random()-0.5)*0.8} 0.05`);
        container.appendChild(box);
      }
    }

    // === ЗАПУСК ===
    document.querySelector('a-scene').addEventListener('loaded', () => {
      document.getElementById('loading').style.display = 'none';

      for (let i = 0; i < 12; i++) {
        const t = document.getElementById(`target-${i}`);
        t.addEventListener('targetFound', () => { activeTarget = i; createPuzzle(i); });
        t.addEventListener('targetLost', () => { if (activeTarget === i) activeTarget = null; });
      }

      // Автозапуск камери + MindAR
      document.body.addEventListener('click', () => {
        const scene = document.querySelector('a-scene');
        scene.systems['mindar-image-system'].start();
        document.getElementById('hint').textContent = 'Перетягуй шматочки пальцем!';
      }, {once: true});
    });
  </script>
</body>
</html>
