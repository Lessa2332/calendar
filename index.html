<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>–ú–∞–≥—ñ—á–Ω–∏–π –ø–∞–∑–ª –¥–ª—è –∑—ñ—Ä–æ—á–∫–∏</title>

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    body, html { margin:0; height:100%; overflow:hidden; background:#000; font-family:'Comic Sans MS',cursive,sans-serif; }
    #hint {
      position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:#ff1493; color:#fff; padding:16px 32px; border-radius:50px;
      font-size:24px; z-index:999; box-shadow:0 0 30px #ff1493; text-align:center;
    }
    #win {
      position:fixed; inset:0; background:rgba(0,0,0,0.97); color:gold; font-size:80px;
      display:none; align-items:center; justify-content:center; flex-direction:column;
      z-index:1000; text-align:center;
    }
    #win span { animation:bounce 1s infinite; }
    @keyframes bounce { 0%,100%{transform:scale(1)} 50%{transform:scale(1.5)} }
    
    #loading {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      color:#fff; font-size:20px; z-index:1001; text-align:center;
    }
  </style>
</head>
<body>

  <div id="hint">–ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –µ–∫—Ä–∞–Ω ‚Üí –ø–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä ‚Üí –∑–±–∏—Ä–∞–π –ø–∞–∑–ª!</div>
  <div id="win"><span>–£–†–ê–ê–ê!</span><br>–¢–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π —á–∞—Ä—ñ–≤–Ω–∏–∫!</div>
  <div id="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

  <a-scene
    mindar-image="imageTargetSrc: calendar.mind;"
    renderer="colorManagement: true; antialias: true;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    cursor="rayOrigin: mouse">

    <a-camera>
      <a-cursor id="cursor" 
                rayOrigin="mouse" 
                fuse="true" 
                fuse-timeout="100"
                material="color: #ff1493; shader: flat">
      </a-cursor>
    </a-camera>

    <!-- 12 –°–¢–ê–¢–ò–ß–ù–ò–• —Ü—ñ–ª–µ–π -->
    <a-entity mindar-image-target="targetIndex: 0" class="target" id="target-0"></a-entity>
    <a-entity mindar-image-target="targetIndex: 1" class="target" id="target-1"></a-entity>
    <a-entity mindar-image-target="targetIndex: 2" class="target" id="target-2"></a-entity>
    <a-entity mindar-image-target="targetIndex: 3" class="target" id="target-3"></a-entity>
    <a-entity mindar-image-target="targetIndex: 4" class="target" id="target-4"></a-entity>
    <a-entity mindar-image-target="targetIndex: 5" class="target" id="target-5"></a-entity>
    <a-entity mindar-image-target="targetIndex: 6" class="target" id="target-6"></a-entity>
    <a-entity mindar-image-target="targetIndex: 7" class="target" id="target-7"></a-entity>
    <a-entity mindar-image-target="targetIndex: 8" class="target" id="target-8"></a-entity>
    <a-entity mindar-image-target="targetIndex: 9" class="target" id="target-9"></a-entity>
    <a-entity mindar-image-target="targetIndex: 10" class="target" id="target-10"></a-entity>
    <a-entity mindar-image-target="targetIndex: 11" class="target" id="target-11"></a-entity>

  </a-scene>

  <!-- –ê—É–¥—ñ–æ -->
  <audio id="yay" preload="auto"></audio>

  <script>
    let activeTargetIndex = null;
    let userInteracted = false;

    // üèóÔ∏è –ó –í–ê–®–û–á –í–ï–†–°–Ü–á: –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –ø–∞–∑–ª—ñ–≤
    let puzzleStates = {};
    let imageCache = {};

    // üéØ –ó –ú–û–Ñ–á –í–ï–†–°–Ü–á: –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∫–ª—ñ–∫—ñ–≤
    AFRAME.registerComponent('puzzle-piece', {
      init: function () {
        this.el.addEventListener('click', (e) => {
          if (!activeTargetIndex !== null && puzzleStates[activeTargetIndex]) {
            const state = puzzleStates[activeTargetIndex];
            if (state.solved) return;

            const piece = this.el;
            const otherPieces = state.pieces.filter(p => p !== piece);
            if (otherPieces.length === 0) return;

            // –ú—ñ–Ω—è—î–º–æ –º—ñ—Å—Ü—è–º–∏ –∑ –≤–∏–ø–∞–¥–∫–æ–≤–æ—é —á–∞—Å—Ç–∏–Ω–∫–æ—é
            const swapPiece = otherPieces[Math.floor(Math.random() * otherPieces.length)];
            const tempPos = piece.getAttribute('position');
            const tempRotation = piece.getAttribute('rotation');
            
            piece.setAttribute('position', swapPiece.getAttribute('position'));
            piece.setAttribute('rotation', swapPiece.getAttribute('rotation'));
            swapPiece.setAttribute('position', tempPos);
            swapPiece.setAttribute('rotation', tempRotation);

            // üèóÔ∏è –ó –í–ê–®–û–á –í–ï–†–°–Ü–á: –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω
            updatePuzzleState(activeTargetIndex);
            checkPuzzleSolved(state.pieces, activeTargetIndex);
          }
        });
      }
    });

    function unlockAudio() {
      if (userInteracted) return;
      userInteracted = true;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      ctx.resume();
      const sounds = document.querySelectorAll('audio');
      sounds.forEach(s => { 
        s.play().catch(()=>{}); 
        s.pause(); 
        s.currentTime = 0; 
      });
    }

    // üèóÔ∏è –ó –í–ê–®–û–á –í–ï–†–°–Ü–á: –∑–∞–ø–∏—Ç –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏
    async function requestCameraAccess() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        console.log('‚úÖ –î–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ');
        document.getElementById('loading').style.display = 'none';
        document.getElementById('hint').textContent = '–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä –∫–∞–º–µ—Ä—ñ! üì±';
      } catch (err) {
        console.error('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏:', err);
        document.getElementById('hint').textContent = '–î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏! üì∑';
        document.getElementById('loading').style.display = 'none';
      }
    }

    // üéØ –ó –ú–û–Ñ–á –í–ï–†–°–Ü–á: –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ —Ä–æ–∑—Ä—ñ–∑–∞–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    function loadAndSliceImage(targetIndex, callback) {
      const imageNumber = String(targetIndex + 1).padStart(2, '0');
      const imageUrl = `images/${imageNumber}.jpg?t=${Date.now()}`;
      
      if (imageCache[imageUrl]) {
        callback(imageCache[imageUrl]);
        return;
      }

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const rows = 3, cols = 3;
        
        const pieceWidth = img.width / cols;
        const pieceHeight = img.height / rows;
        
        const pieces = [];
        
        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            const pieceCanvas = document.createElement('canvas');
            pieceCanvas.width = pieceWidth;
            pieceCanvas.height = pieceHeight;
            const pieceCtx = pieceCanvas.getContext('2d');
            
            // –í–∏—Ä—ñ–∑–∞—î–º–æ —á–∞—Å—Ç–∏–Ω—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            pieceCtx.drawImage(
              img,
              col * pieceWidth, row * pieceHeight, pieceWidth, pieceHeight,
              0, 0, pieceWidth, pieceHeight
            );
            
            pieces.push({
              dataUrl: pieceCanvas.toDataURL(),
              row: row,
              col: col,
              originalPosition: {
                x: (col - 1) * (0.2 + 0.01),
                y: (1 - row) * (0.2 + 0.01),
                z: 0.02
              }
            });
          }
        }
        
        imageCache[imageUrl] = pieces;
        callback(pieces);
      };
      
      img.onerror = function() {
        console.error(`‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è: ${imageUrl}`);
        callback(null);
      };
      
      img.src = imageUrl;
    }

    // üèóÔ∏è –ó –í–ê–®–û–á –í–ï–†–°–Ü–á: —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è/–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞–∑–ª—É
    function createOrRestorePuzzle(targetIndex) {
      const container = document.getElementById(`target-${targetIndex}`);
      if (!container) return;

      // –Ø–∫—â–æ –ø–∞–∑–ª –≤–∂–µ —ñ—Å–Ω—É—î ‚Äî –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ
      if (puzzleStates[targetIndex] && !puzzleStates[targetIndex].solved) {
        console.log(`üîÑ –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–∞–∑–ª –¥–ª—è —Ü—ñ–ª—ñ ${targetIndex}`);
        restorePuzzle(targetIndex);
        return;
      }

      // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –ø–∞–∑–ª
      loadAndSliceImage(targetIndex, (piecesData) => {
        if (!piecesData) {
          createFallbackPuzzle(targetIndex);
          return;
        }

        const pieces = [];
        const scale = 0.2;
        const spacing = 0.01;

        container.innerHTML = '';

        piecesData.forEach((pieceData, index) => {
          const piece = document.createElement('a-plane');
          piece.setAttribute('src', pieceData.dataUrl);
          piece.setAttribute('width', scale);
          piece.setAttribute('height', scale);
          piece.setAttribute('puzzle-piece', '');
          piece.setAttribute('class', 'piece clickable');
          piece.setAttribute('data-piece-id', `${pieceData.row}-${pieceData.col}`);

          // üèóÔ∏è –ó –í–ê–®–û–á –í–ï–†–°–Ü–á: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó –∞–±–æ –≤–∏–ø–∞–¥–∫–æ–≤—ñ
          const startX = (Math.random() - 0.5) * 0.8;
          const startY = (Math.random() - 0.5) * 0.8;
          const startRotation = Math.random() * 360;

          piece.setAttribute('position', { x: startX, y: startY, z: 0.05 });
          piece.setAttribute('rotation', { x: 0, y: 0, z: startRotation });
          piece.setAttribute('data-target-x', pieceData.originalPosition.x);
          piece.setAttribute('data-target-y', pieceData.originalPosition.y);
          piece.setAttribute('data-target-z', pieceData.originalPosition.z);
          piece.setAttribute('data-target-rotation', 0);

          container.appendChild(piece);
          pieces.push(piece);
        });

        // üèóÔ∏è –ó –í–ê–®–û–á –í–ï–†–°–Ü–á: –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞–Ω
        puzzleStates[targetIndex] = {
          pieces: pieces,
          solved: false,
          targetIndex: targetIndex,
          piecesData: piecesData
        };

        // üéØ –ó –ú–û–Ñ–á –í–ï–†–°–Ü–á: –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–µ –∞—É–¥—ñ–æ
        const audio = document.getElementById('yay');
        const audioNumber = String(targetIndex + 1).padStart(2, '0');
        audio.src = `fon/${audioNumber}.mp3`;

        console.log(`‚úÖ –ü–∞–∑–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ –¥–ª—è —Ü—ñ–ª—ñ ${targetIndex}`);
      });
    }

    // üèóÔ∏è –ó –í–ê–®–û–á –í–ï–†–°–Ü–á: –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞–∑–ª—É
    function restorePuzzle(targetIndex) {
      const state = puzzleStates[targetIndex];
      if (!state) return;

      const container = document.getElementById(`target-${targetIndex}`);
      if (!container) return;

      if (state.solved) {
        showWinScreen();
        return;
      }

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤—Å—ñ —á–∞—Å—Ç–∏–Ω–∫–∏ –Ω–∞ –º—ñ—Å—Ü—ñ
      state.pieces.forEach(piece => {
        if (!piece.parentNode) {
          container.appendChild(piece);
        }
      });
    }

    // üèóÔ∏è –ó –í–ê–®–û–á –í–ï–†–°–Ü–á: –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É
    function updatePuzzleState(targetIndex) {
      const state = puzzleStates[targetIndex];
      if (!state) return;

      // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—ó –≤ —Å—Ç–∞–Ω—ñ
      state.pieces.forEach(piece => {
        // –°—Ç–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç–∏ A-Frame
      });
    }

    function createFallbackPuzzle(targetIndex) {
      const container = document.getElementById(`target-${targetIndex}`);
      if (!container) return;

      const pieces = [];
      const rows = 3, cols = 3;
      const scale = 0.15;
      const spacing = 0.02;

      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const piece = document.createElement('a-box');
          const hue = (row * cols + col) * 40;
          
          piece.setAttribute('color', `hsl(${hue}, 100%, 50%)`);
          piece.setAttribute('depth', 0.01);
          piece.setAttribute('width', scale);
          piece.setAttribute('height', scale);
          piece.setAttribute('puzzle-piece', '');
          piece.setAttribute('class', 'piece clickable');
          piece.setAttribute('data-piece-id', `${row}-${col}`);

          const targetX = (col - 1) * (scale + spacing);
          const targetY = (1 - row) * (scale + spacing);
          const startX = (Math.random() - 0.5) * 0.6;
          const startY = (Math.random() - 0.5) * 0.6;

          piece.setAttribute('position', { x: startX, y: startY, z: 0.05 });
          piece.setAttribute('data-target-x', targetX);
          piece.setAttribute('data-target-y', targetY);
          piece.setAttribute('data-target-z', 0.02);

          container.appendChild(piece);
          pieces.push(piece);
        }
      }

      puzzleStates[targetIndex] = {
        pieces: pieces,
        solved: false,
        targetIndex: targetIndex
      };
    }

    // üéØ –ö–û–ú–ë–Ü–ù–û–í–ê–ù–ê –§–£–ù–ö–¶–Ü–Ø: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑—ñ–±—Ä–∞–Ω–æ—Å—Ç—ñ
    function checkPuzzleSolved(pieces, targetIndex) {
      const solved = pieces.every(piece => {
        const pos = piece.getAttribute('position');
        const rotation = piece.getAttribute('rotation');
        const targetX = parseFloat(piece.getAttribute('data-target-x'));
        const targetY = parseFloat(piece.getAttribute('data-target-y'));
        const targetZ = parseFloat(piece.getAttribute('data-target-z'));
        const targetRotation = parseFloat(piece.getAttribute('data-target-rotation'));
        
        return Math.abs(pos.x - targetX) < 0.05 && 
               Math.abs(pos.y - targetY) < 0.05 && 
               Math.abs(pos.z - targetZ) < 0.05 &&
               Math.abs(rotation.z - targetRotation) < 10;
      });

      if (solved) {
        console.log('üéâ –ü–∞–∑–ª –∑—ñ–±—Ä–∞–Ω–æ!');
        puzzleStates[targetIndex].solved = true;
        showWinScreen();
      }
    }

    function showWinScreen() {
      document.getElementById('win').style.display = 'flex';

      const audio = document.getElementById('yay');
      audio.play().catch(e => console.log('üîá –ó–≤—É–∫ –Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–æ:', e));

      confetti({ 
        particleCount: 500, 
        spread: 120, 
        origin: { y: 0.6 },
        colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff']
      });
    }

    // üèóÔ∏è –ó –í–ê–®–û–á –í–ï–†–°–Ü–á: –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π —Ü—ñ–ª–µ–π
    function setupEventListeners() {
      for (let i = 0; i < 12; i++) {
        const target = document.getElementById(`target-${i}`);
        if (target) {
          target.addEventListener('targetFound', (e) => {
            console.log(`üéØ –ó–Ω–∞–π–¥–µ–Ω–æ —Ü—ñ–ª—å: ${i}`);
            if (activeTargetIndex === i) return;
            activeTargetIndex = i;
            setTimeout(() => createOrRestorePuzzle(i), 100);
          });
          
          target.addEventListener('targetLost', (e) => {
            console.log(`‚ùå –í—Ç—Ä–∞—á–µ–Ω–æ —Ü—ñ–ª—å: ${i}`);
            if (activeTargetIndex === i) {
              activeTargetIndex = null;
            }
          });
        }
      }
    }

    // üöÄ –°–£–ü–ï–†-–Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
    document.querySelector('a-scene').addEventListener('loaded', async () => {
      console.log('üé¨ –°—Ü–µ–Ω–∞ A-Frame –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
      
      setupEventListeners();
      await requestCameraAccess();
      
      document.body.addEventListener('click', unlockAudio, { once: true });

      document.body.addEventListener('click', () => {
        const scene = document.querySelector('a-scene');
        if (scene && scene.systems['mindar-image-system']) {
          console.log('üöÄ –ó–∞–ø—É—Å–∫ MindAR —Å–∏—Å—Ç–µ–º–∏');
          scene.systems['mindar-image-system'].start();
          document.getElementById('hint').textContent = '–ó–Ω–∞–π–¥–∏ –º–∞—Ä–∫–µ—Ä —Ç–∞ –∫–ª—ñ–∫–∞–π –Ω–∞ –ø–∞–∑–ª! üß©';
        }
      }, { once: true });
    });

    window.addEventListener('beforeunload', () => {
      // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
    });
  </script>
</body>
</html>
