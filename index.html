<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>–ú–∞–≥—ñ—á–Ω–∏–π –ø–∞–∑–ª –¥–ª—è –∑—ñ—Ä–æ—á–∫–∏</title>

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    body, html { margin:0; height:100%; overflow:hidden; background:#000; font-family:'Comic Sans MS',cursive,sans-serif; }
    #hint {
      position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:#ff1493; color:#fff; padding:16px 32px; border-radius:50px;
      font-size:24px; z-index:999; box-shadow:0 0 30px #ff1493; text-align:center;
    }
    #win {
      position:fixed; inset:0; background:rgba(0,0,0,0.97); color:gold; font-size:80px;
      display:none; align-items:center; justify-content:center; flex-direction:column;
      z-index:1000; text-align:center;
    }
    #win span { animation:bounce 1s infinite; }
    @keyframes bounce { 0%,100%{transform:scale(1)} 50%{transform:scale(1.5)} }
    
    #loading {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      color:#fff; font-size:20px; z-index:1001; text-align:center;
    }
  </style>
</head>
<body>

  <div id="hint">–ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –µ–∫—Ä–∞–Ω ‚Üí –ø–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä ‚Üí –∑–±–∏—Ä–∞–π –ø–∞–∑–ª!</div>
  <div id="win"><span>–£–†–ê–ê–ê!</span><br>–¢–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π —á–∞—Ä—ñ–≤–Ω–∏–∫!</div>
  <div id="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

  <a-scene
    mindar-image="imageTargetSrc: calendar.mind;"
    renderer="colorManagement: true; antialias: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-camera staticCamera="false" position="0 0 0"></a-camera>
    <a-entity id="targets-container"></a-entity>
  </a-scene>

  <!-- –ê—É–¥—ñ–æ -->
  <audio id="yay" preload="auto" src="fon/01.mp3"></audio>

  <script>
    let activeTargetIndex = null;
    let clickHandler = null;
    let targetsCreated = false;
    let userInteracted = false;

    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞–Ω –ø–∞–∑–ª—ñ–≤ –¥–ª—è –∫–æ–∂–Ω–æ—ó —Ü—ñ–ª—ñ
    let puzzleStates = {};

    function unlockAudio() {
      if (userInteracted) return;
      userInteracted = true;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      ctx.resume();
      const sounds = document.querySelectorAll('audio');
      sounds.forEach(s => { 
        s.play().catch(()=>{}); 
        s.pause(); 
        s.currentTime = 0; 
      });
    }

    async function requestCameraAccess() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        console.log('‚úÖ –î–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ');
        document.getElementById('loading').style.display = 'none';
        document.getElementById('hint').textContent = '–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä –∫–∞–º–µ—Ä—ñ! üì±';
      } catch (err) {
        console.error('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏:', err);
        document.getElementById('hint').textContent = '–î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏! üì∑';
        document.getElementById('loading').style.display = 'none';
      }
    }

    function createTargets() {
      if (targetsCreated) return;
      const container = document.getElementById('targets-container');
      
      for (let i = 0; i < 12; i++) {
        const target = document.createElement('a-entity');
        target.setAttribute('mindar-image-target', { targetIndex: i });
        target.id = `target-${i}`;
        
        target.addEventListener('targetFound', (e) => {
          console.log(`üéØ –ó–Ω–∞–π–¥–µ–Ω–æ —Ü—ñ–ª—å: ${i}`);
          onTargetFound(e);
        });
        
        target.addEventListener('targetLost', (e) => {
          console.log(`‚ùå –í—Ç—Ä–∞—á–µ–Ω–æ —Ü—ñ–ª—å: ${i}`);
          onTargetLost(e);
        });
        
        container.appendChild(target);
      }
      targetsCreated = true;
      console.log('‚úÖ 12 —Ü—ñ–ª–µ–π —Å—Ç–≤–æ—Ä–µ–Ω–æ');
    }

    function resetPuzzle(targetIndex) {
      if (clickHandler) {
        document.querySelector('a-scene').removeEventListener('click', clickHandler);
        clickHandler = null;
      }
      
      // –û—á–∏—â–∞—î–º–æ –ø–∞–∑–ª –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Ü—ñ–ª—ñ
      const container = document.getElementById(`target-${targetIndex}`);
      if (container) {
        container.innerHTML = '';
      }
      
      delete puzzleStates[targetIndex];
      console.log(`üîÑ –ü–∞–∑–ª –¥–ª—è —Ü—ñ–ª—ñ ${targetIndex} —Å–∫–∏–Ω—É—Ç–æ`);
    }

    function createPuzzle(targetIndex) {
      const container = document.getElementById(`target-${targetIndex}`);
      if (!container) {
        console.error(`‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ü—ñ–ª—ñ ${targetIndex} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ`);
        return;
      }

      // –Ø–∫—â–æ –ø–∞–∑–ª –≤–∂–µ —ñ—Å–Ω—É—î ‚Äî –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ
      if (puzzleStates[targetIndex] && !puzzleStates[targetIndex].solved) {
        console.log(`üîÑ –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–∞–∑–ª –¥–ª—è —Ü—ñ–ª—ñ ${targetIndex}`);
        restorePuzzle(targetIndex);
        return;
      }

      // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –ø–∞–∑–ª
      const pieces = [];
      const rows = 3, cols = 3;
      const scale = 0.15;
      const spacing = 0.02;

      // –®–ª—è—Ö –¥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ –Ω–∞ –≤–∞—à–µ)
      const imagePath = 'fon/05.jpg'; // ‚¨ÖÔ∏è –ó–ú–Ü–ù–ò–¢–¨ –¶–ï –ù–ê –®–õ–Ø–• –î–û –í–ê–®–û–ì–û –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø

      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const piece = document.createElement('a-plane');
          piece.setAttribute('width', scale);
          piece.setAttribute('height', scale);
          piece.setAttribute('depth', 0.01);

          // –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –ø–æ–∑–∏—Ü—ñ—è –¥–ª—è –∑—ñ–±—Ä–∞–Ω–æ–≥–æ –ø–∞–∑–ª—É
          const targetX = (col - 1) * (scale + spacing);
          const targetY = (1 - row) * (scale + spacing);

          // –í–∏–ø–∞–¥–∫–æ–≤–∞ —Å—Ç–∞—Ä—Ç–æ–≤–∞ –ø–æ–∑–∏—Ü—ñ—è
          const startX = (Math.random() - 0.5) * 0.8;
          const startY = (Math.random() - 0.5) * 0.8;

          piece.setAttribute('position', { x: startX, y: startY, z: 0.05 });
          piece.setAttribute('data-target-x', targetX);
          piece.setAttribute('data-target-y', targetY);
          piece.setAttribute('data-target-z', 0.02);
          piece.setAttribute('data-row', row);
          piece.setAttribute('data-col', col);
          piece.classList.add('piece');

          // –î–æ–¥–∞—î–º–æ —Ç–µ–∫—Å—Ç (–Ω–æ–º–µ—Ä)
          const text = document.createElement('a-text');
          text.setAttribute('value', `${row * cols + col + 1}`);
          text.setAttribute('align', 'center');
          text.setAttribute('color', '#fff');
          text.setAttribute('position', '0 0 0.006');
          text.setAttribute('scale', '0.2 0.2 0.2');
          piece.appendChild(text);

          // –î–æ–¥–∞—î–º–æ —Ç–µ–∫—Å—Ç—É—Ä—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
          const material = document.createElement('a-material');
          material.setAttribute('src', imagePath);
          material.setAttribute('shader', 'flat');
          material.setAttribute('repeat', '1 1');
          material.setAttribute('offset', `${col / cols} ${1 - (row + 1) / rows}`); // ‚¨ÖÔ∏è –í–∏—Ä—ñ–∑–∞—î–º–æ —á–∞—Å—Ç–∏–Ω–∫—É
          material.setAttribute('repeat', `${cols} ${rows}`); // ‚¨ÖÔ∏è –ú–∞—Å—à—Ç–∞–±—É—î–º–æ, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —á–∞—Å—Ç–∏–Ω–∫—É

          piece.appendChild(material);

          container.appendChild(piece);
          pieces.push(piece);
        }
      }

      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞–Ω –ø–∞–∑–ª—É
      puzzleStates[targetIndex] = {
        pieces: pieces,
        solved: false,
        targetIndex: targetIndex
      };

      // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É
      clickHandler = (e) => {
        if (!e.detail || !e.detail.intersectedEl) return;
        const piece = e.detail.intersectedEl;
        if (!piece || !piece.classList.contains('piece')) return;

        const state = puzzleStates[targetIndex];
        if (!state || state.solved) return;

        const otherPieces = state.pieces.filter(p => p !== piece);
        if (otherPieces.length === 0) return;

        // –ú—ñ–Ω—è—î–º–æ –º—ñ—Å—Ü—è–º–∏ –∑ –≤–∏–ø–∞–¥–∫–æ–≤–æ—é —á–∞—Å—Ç–∏–Ω–∫–æ—é
        const swapPiece = otherPieces[Math.floor(Math.random() * otherPieces.length)];
        const tempPos = piece.getAttribute('position');
        piece.setAttribute('position', swapPiece.getAttribute('position'));
        swapPiece.setAttribute('position', tempPos);

        checkPuzzleSolved(state.pieces, targetIndex);
      };

      document.querySelector('a-scene').addEventListener('click', clickHandler);
      console.log(`‚úÖ –ü–∞–∑–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ –¥–ª—è —Ü—ñ–ª—ñ ${targetIndex}`);
    }

    function restorePuzzle(targetIndex) {
      const state = puzzleStates[targetIndex];
      if (!state) return;

      const container = document.getElementById(`target-${targetIndex}`);
      if (!container) return;

      if (state.solved) {
        document.getElementById('win').style.display = 'flex';
        return;
      }

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—Å—ñ —á–∞—Å—Ç–∏–Ω–∫–∏ —â–µ —ñ—Å–Ω—É—é—Ç—å
      state.pieces.forEach(piece => {
        if (!piece.parentNode) {
          console.log('‚ö†Ô∏è –ß–∞—Å—Ç–∏–Ω–∫–∞ –≤—ñ–¥—Å—É—Ç–Ω—è ‚Äî –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä—é—î–º–æ –ø–∞–∑–ª');
          resetPuzzle(targetIndex);
          createPuzzle(targetIndex);
          return;
        }
      });

      // –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—ñ–¥–∫–ª—é—á–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫
      if (clickHandler) {
        document.querySelector('a-scene').removeEventListener('click', clickHandler);
      }

      clickHandler = (e) => {
        if (!e.detail || !e.detail.intersectedEl) return;
        const piece = e.detail.intersectedEl;
        if (!piece || !piece.classList.contains('piece')) return;

        const state = puzzleStates[targetIndex];
        if (!state || state.solved) return;

        const otherPieces = state.pieces.filter(p => p !== piece);
        if (otherPieces.length === 0) return;

        const swapPiece = otherPieces[Math.floor(Math.random() * otherPieces.length)];
        const tempPos = piece.getAttribute('position');
        piece.setAttribute('position', swapPiece.getAttribute('position'));
        swapPiece.setAttribute('position', tempPos);

        checkPuzzleSolved(state.pieces, targetIndex);
      };

      document.querySelector('a-scene').addEventListener('click', clickHandler);
    }

    function checkPuzzleSolved(pieces, targetIndex) {
      const solved = pieces.every(piece => {
        const pos = piece.getAttribute('position');
        const targetX = parseFloat(piece.getAttribute('data-target-x'));
        const targetY = parseFloat(piece.getAttribute('data-target-y'));
        const targetZ = parseFloat(piece.getAttribute('data-target-z'));

        return Math.abs(pos.x - targetX) < 0.05 &&
               Math.abs(pos.y - targetY) < 0.05 &&
               Math.abs(pos.z - targetZ) < 0.05;
      });

      if (solved) {
        console.log('üéâ –ü–∞–∑–ª –∑—ñ–±—Ä–∞–Ω–æ!');
        puzzleStates[targetIndex].solved = true;

        document.getElementById('win').style.display = 'flex';

        const audio = document.getElementById('yay');
        audio.play().catch(e => console.log('üîá –ó–≤—É–∫ –Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–æ:', e));

        confetti({
          particleCount: 300,
          spread: 100,
          origin: { y: 0.6 },
          colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff']
        });

        if (clickHandler) {
          document.querySelector('a-scene').removeEventListener('click', clickHandler);
          clickHandler = null;
        }
      }
    }

    function onTargetFound(e) {
      const target = e.target;
      const targetAttr = target.getAttribute('mindar-image-target');
      if (!targetAttr) return;
      
      const idx = targetAttr.targetIndex;
      console.log(`üéØ –û–±—Ä–æ–±–∫–∞ –∑–Ω–∞–π–¥–µ–Ω–æ—ó —Ü—ñ–ª—ñ: ${idx}`);
      
      if (activeTargetIndex === idx) return;
      
      activeTargetIndex = idx;
      
      // –°—Ç–≤–æ—Ä—é—î–º–æ –∞–±–æ –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–∞–∑–ª
      setTimeout(() => createPuzzle(idx), 300);
    }

    function onTargetLost(e) {
      const target = e.target;
      const targetAttr = target.getAttribute('mindar-image-target');
      if (!targetAttr) return;
      
      const idx = targetAttr.targetIndex;
      console.log(`‚ùå –í—Ç—Ä–∞—á–µ–Ω–æ —Ü—ñ–ª—å: ${idx}`);
      
      if (activeTargetIndex === idx) {
        activeTargetIndex = null;
        // –ù–µ —Å–∫–∏–¥–∞—î–º–æ –ø–∞–∑–ª ‚Äî –ø—Ä–æ—Å—Ç–æ –∑—É–ø–∏–Ω—è—î–º–æ –≤–∑–∞—î–º–æ–¥—ñ—é
      }
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    document.querySelector('a-scene').addEventListener('loaded', async () => {
      console.log('üé¨ –°—Ü–µ–Ω–∞ A-Frame –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
      
      createTargets();

      // –ó–∞–ø–∏—Ç—É—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏
      await requestCameraAccess();

      // –†–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ –∞—É–¥—ñ–æ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∫–ª—ñ–∫—É
      document.body.addEventListener('click', unlockAudio, { once: true });

      // –ó–∞–ø—É—Å–∫ MindAR –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∫–ª—ñ–∫—É
      document.body.addEventListener('click', () => {
        const scene = document.querySelector('a-scene');
        if (scene && scene.systems['mindar-image-system']) {
          console.log('üöÄ –ó–∞–ø—É—Å–∫ MindAR —Å–∏—Å—Ç–µ–º–∏');
          scene.systems['mindar-image-system'].start();
        }
      }, { once: true });

      // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
      window.addEventListener('beforeunload', () => {
        if (clickHandler) {
          document.querySelector('a-scene').removeEventListener('click', clickHandler);
        }
      });
    });
  </script>
</body>
</html>
