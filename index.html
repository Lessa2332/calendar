<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Магічний зимовий пазл</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@2.2.1/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <style>
    body,html{margin:0;height:100%;overflow:hidden;background:#000}
    #hint{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#ff1493;color:#fff;padding:18px 36px;border-radius:50px;font-size:24px;z-index:999;font-family:"Comic Sans MS",sans-serif;box-shadow:0 0 35px #ff69b4}
    #win{position:fixed;inset:0;background:rgba(0,0,20,0.98);color:#ffd700;font-size:80px;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:1000}
    #win span{animation:bounce 1.2s infinite}
    @keyframes bounce{0%,100%{transform:scale(1)}50%{transform:scale(1.55)}}
  </style>
</head>
<body>

<div id="hint">Покажи маркер – іній розтане, а магія почнеться!</div>
<div id="win"><span>УРААА!</span><br>Ти розтопив зиму!</div>

<a-scene embedded mindar-image="imageTargetSrc: calendar.mind"
         renderer="colorManagement:true"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:false">

  <a-camera></a-camera>

  <a-entity mindar-image-target="targetIndex:0">
    <a-entity id="puzzle-container"></a-entity>
  </a-entity>

</a-scene>

<audio id="yay" src="https://assets.mixkit.co/sfx/preview/mixkit-magical-coin-win-1937.mp3" preload="auto"></audio>

<script>
// 1. Правильний запуск MindAR 2.2.1
document.querySelector('a-scene').addEventListener('loaded', () => {
  const scene = document.querySelector('a-scene');
  scene.components['mindar-image-system'].start();
});

// 2. Створюємо пазл при виявленні маркера
let created = false;
document.querySelector('a-scene').addEventListener('targetFound', () => {
  if (created) return;
  created = true;
  setTimeout(initPuzzle, 700);
});

async function initPuzzle() {
  const container = document.getElementById('puzzle-container');
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = 'images/01.jpg?t=' + Date.now();
  await img.decode();

  const pw = img.width / 3, ph = img.height / 3;
  const sw = 0.5 / 3, sh = (img.height / img.width) * 0.5 / 3;
  const pieces = [];

  // Створюємо 9 шматочків
  for (let row = 0; row < 3; row++) {
    for (let col = 0; col < 3; col++) {
      const canvas = document.createElement('canvas');
      canvas.width = pw; canvas.height = ph;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, col*pw, row*ph, pw, ph, 0, 0, pw, ph);

      const plane = document.createElement('a-plane');
      plane.setAttribute('src', canvas.toDataURL());
      plane.setAttribute('width', sw*2);
      plane.setAttribute('height', sh*2);
      plane.setAttribute('position', `${(Math.random()-0.5)*1.4} ${(Math.random()-0.5)*1.4} 0.02`);
      plane.setAttribute('data-target-x', (col-1)*sw);
      plane.setAttribute('data-target-y', (1-row)*sh);
      plane.classList.add('piece','raycastable');
      container.appendChild(plane);
      pieces.push(plane);
    }
  }

  // Іній зверху
  const frost = document.createElement('a-plane');
  frost.setAttribute('material', 'shader:flat; color:#e3f2fd; opacity:0.88; transparent:true');
  frost.setAttribute('width', 0.55);
  frost.setAttribute('height', 0.55 * img.height/img.width + 0.05);
  frost.setAttribute('position', '0 0 0.015');
  frost.id = 'frost-layer';
  container.appendChild(frost);

  // Перший дотик — розтоплюємо іній
  const meltFrost = () => {
    frost.setAttribute('animation', 'property: material.opacity; from:0.88; to:0; dur:1400; easing:easeOutQuad');
    setTimeout(() => frost.remove(), 1500);
    document.querySelector('a-scene').removeEventListener('click', meltFrost);
  };
  document.querySelector('a-scene').addEventListener('click', meltFrost);

  // Клік по шматочку після розтоплення
  document.querySelector('a-scene').addEventListener('click', function handler(e) {
    const piece = e.detail.intersectedEls?.[0];
    if (!piece || !piece.classList.contains('piece')) return;

    const other = pieces.filter(p => p !== piece)[Math.floor(Math.random()*8)];
    const tmp = piece.getAttribute('position');
    piece.setAttribute('position', other.getAttribute('position'));
    other.setAttribute('position', tmp);

    // Перемога!
    if (pieces.every(p => {
      const pos = p.getAttribute('position');
      const tx = parseFloat(p.dataset.targetX);
      const ty = parseFloat(p.dataset.targetY);
      return Math.abs(pos.x - tx) < 0.08 && Math.abs(pos.y - ty) < 0.08;
    })) {
      document.getElementById('win').style.display = 'flex';
      document.getElementById('yay').play();
      confetti({particleCount:700, spread:130, origin:{y:0.65}});
      this.removeEventListener('click', handler);
    }
  });
}
</script>
</body>
</html>

